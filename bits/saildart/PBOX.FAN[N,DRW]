;MACROS
DEFINE BOXFIT $ (H,W,BOX,LAB,WIN)
<	MOVEI TTT,W
	BSCALE(TTT)
	CAMLE T,TTT
	JRST NO$.$BOX
	MOVEI TTT,H-LAB
	BSCALE(TTT)
	CAMLE TT,TTT
	JRST NO$.$BOX
	TLNE FLAG,QUICK
	OUTSTR[ASCIZ/"BOX" OK
/]
	TLNN FLAG,QUICK
	OUTSTR[ASCIZ/SIZE BOX IS BIG ENOUGH!
/]
	JRST WIN

NO$.$BOX:
>
;GETSCL
MD,<
GETSCL:
NODEC,<	TRNE FLAG,%DOPLT
	TDNE FLAG,[QUICK,,DSKOUT,<DODSK!>MXGP,<XGP!>0]
	CAIA
	OUTSTR[ASCIZ/PUT PEN BOTTOM CENTER.
/]
>;NODEC
NOPUTP:	SKIPE PARG
	JRST [	MOVEI TTT,1
		JRST GOTSCL]
	SKIPE TTT,SCALE1		;SCALE TYPE IN AT START?
	JRST GOTSCL			;YES
	TRNE FLAG,PRODUCE
	JRST [	MOVEI TTT,2
MXGP,<		TRNE FLAG,XGP
		MOVEI TTT,1
>;MXGP
		JRST GOTSCL]
ASK:	TLNN FLAG,QUICK
	OUTSTR[ASCIZ/SCALE FACTOR?/]
	TLNE FLAG,QUICK
	OUTSTR[ASCIZ/SCALE?/]
	PUSHJ P,DECIN
	JRST [	PUSHJ P,IERR
		JRST ASK]
	JUMPN TTT,GOTSCL
	MOVEI TTT,2		;MAKE CR-LF INTO SIZE 2
MXGP,<	TRNE FLAG,XGP	;UNLESS XGP
	JRST [	MOVEI TTT,1
		TLNN FLAG,QUICK
		OUTSTR[ASCIZ/USING SCALE 1!
/]
		JRST GOTSCL]
>;MXGP
	TLNN FLAG,QUICK
	OUTSTR[ASCIZ/USING SCALE 2!
/]
GOTSCL:	MOVEM TTT,NSCALE
	SKIPE SCALE1		;WE COULD BE CHANGING THE DEFAULT
	MOVEM TTT,SCALE1	;SO STORE HERE
NOSPLIT,<MOVE T,FROTIT		;GET MASTER FLAG
	MOVEM T,%ROTIT		;SET FOR THIS TIME
>;NOSPLIT
	MOVE T,LRGX
	SUB T,SMLX
	SCALE(T)
	IMULI T,5
CMU,<	IMUL T,INC.MIL5
	ASH T,BSCL,<-1>-=18
>;CMU
	TLNN FLAG,QUICK
	OUTSTR[ASCIZ/THAT'S /]
	PUSHJ P,MILOUT
	TLNN FLAG,QUICK
	OUTSTR[ASCIZ/ INCHES WIDE, AND /]
	TLNE FLAG,QUICK
	OUTSTR[ASCIZ/  X  /]
	MOVE T,LRGY
	SUB T,SMLY
	SCALE(T)
	IMULI T,5
CMU,<	IMUL T,INC.MIL5
	ASH T,BSCL,<-1>-=18
>;CMU
	PUSHJ P,MILOUT
	TLNN FLAG,QUICK
	OUTSTR[ASCIZ/ INCHES HIGH.
/]
	TLNE FLAG,QUICK
	OUTSTR[ASCIZ/
/]
BSCL,<	TRNE FLAG,PRODUCE
	JRST DEFBSC
ASKBSC:	TLNN FLAG,QUICK
	OUTSTR [ ASCIZ /BOX SCALE FACTOR * 2? /]
	TLNE FLAG,QUICK
	OUTSTR [ ASCIZ /BOX SCL?/]
	PUSHJ P,DECIN
	JRST [	PUSHJ P,IERR
		OUTSTR [ ASCIZ /HUH?
/]
		JRST ASKBSC ]
	JUMPN TTT,GOTBSC
DEFBSC:
CMU,<	SKIPA TTT,[1]>		;CMU LIKES A SCALE OF 1
	MOVEI TTT,2
GOTBSC:	MOVEM TTT,BSCALF
>;BSCL
	MOVE T,LRGX
	SUB T,SMLX
	MOVEM T,WIDTH
	MOVE T,LRGY
	SUB T,SMLY
	MOVEM T,HEIGHT
	SKIPE T,PARG			;CHECK FOR BOX ALREADY SET
	JRST [	ADDI T,"A"-1
TELBOX:		OUTSTR[ASCIZ/USING "/]
		CMU,<TRNN FLAG,VERTICAL>		;VERTICAL MODE?
		TRNE T,200000			;VERTICAL BOX?
		OUTCHR["V"]
		OUTCHR T
		OUTSTR[ASCIZ/" BOX.
/]
		TRZE T,200000		;VERTICAL BOX?
		TLOA FLAG,TFLG
		TLZ FLAG,TFLG
		JRST BOXGOT]
	TRNE FLAG,PRODUCE
	JRST [
MXGP,<
CMU,<
BSCL,<		SOJE TTT,USECBX>	;UH  I THINK I WHAT THIS HERE?!?!?
>;CMU
		TRNE FLAG,XGP
		JRST [	TLNE FLAG,QUICK
			OUTSTR[ASCIZ/ "X" BOX
/]
			JRST XGPBOX]
>;MXGP
	NODEC,<
USECBX:		MOVEI T,"C"
		TLNN FLAG,QUICK		;PRINT ABREVIATED MESSAGE?
		JRST TELBOX		;NO  PRINT UNABREVIATED MESSAGE
		OUTSTR[ASCIZ/"C" BOX
/]
>;NODEC
	DEC,<	MOVEI T,"D"
		TLNE FLAG,QUICK
		OUTSTR[ASCIZ/"D" BOX
/]
>;DEC
		JRST BOXGOT]
	MOVE T,WIDTH
	SCALE(T)
	MOVE TT,HEIGHT
	SCALE(TT)
	BOXFIT(AH,AW,A,LABH,HWIN)
MXGP,<	TRNN FLAG,XGP
	JRST XGPNOK
	BOXFIT(XGPH,XGPW,X,XGPLAB,HWIN)
XGPNOK:
>;MXGP
	BOXFIT(BH,BW,B,DLABH,HWIN)
	BOXFIT(CH,CW,C,DLABH,HWIN)
	BOXFIT(DH,DW,D,DLABH,HWIN)
	BOXFIT(EH,EW,E,DLABH,HWIN)
	TLOA FLAG,TFLG				;FLAG LOSSAGE HERE
HWIN:	TLZ FLAG,TFLG
IFGE BH-LABW < BOXFIT(BW,BH,VB,DLABH,ASKSIZ) >
	BOXFIT(CW,CH,VC,DLABH,ASKSIZ)
	BOXFIT(DW,DH,VD,DLABH,ASKSIZ)
	BOXFIT(EW,EH,VE,DLABH,ASKSIZ)
	TLNN FLAG,TFLG
	JRST ASKSIZ
	TLNE FLAG,QUICK
	OUTSTR[ASCIZ/TOO BIG!
/]
	TLNN FLAG,QUICK
	OUTSTR[ASCIZ/NO SIZE IS BIG ENOUGH!
/]
	JRST ASKSIZ
;ASK BOX SIZE AND SETUP BOX INFO(D)
MXGP,<
XGPBOX:	MOVE E,[XGPW,,XGPH]
	MOVE T,[XGPW,,XGPLAB]
	MOVEM T,LABSIZ			;3 TENTHS INCH HIGH LABEL BOX
	MOVE T,[XWD -XGPLEN,XGPTAB]
	TRO FLAG,BXGP
	JRST NOBRDA
>;MXGP

ASKSIZ:
MXGP,<
	TRZ FLAG,BXGP
	TLNN FLAG,QUICK
	OUTSTR[ASCIZ/X, /]
>;MXGP
	TLNN FLAG,QUICK
	OUTSTR[ASCIZ/A, B, C, D OR E (PRECEDE WITH V FOR VERTICAL FORMAT)
OR SET:S OR FIT:F OR NONE:<CR> OR RESET SCALE:R ?/]
	TLNE FLAG,QUICK
	OUTSTR[ASCIZ/BOX?/]
	PUSHJ P,GETCHL
	CAIN T,"V"
	TLOA FLAG,TFLG
	TLZA FLAG,TFLG
	PUSHJ P,GETCHL
	MOVE TT,T
	CAIE T,12		;ALREADY HAVE LF?
	PUSHJ P,GETCHL
	CAIE T,12
	JRST [	PUSHJ P,IERR
		OUTSTR[ASCIZ/HO, HO, HO!
/]
		JRST ASKSIZ]
	CAIN TT,"R"		;LET HIM RESET SCALE
	JRST ASK		;EVEN IF SPECIFIED IN OUTPUT MODES
	MOVE T,TT
BOXGOT:	SETZB E,LABSIZ
	CAIN T,12
	JRST NOBRDA
DEC,<	DPB T,[POINT 7,LSIZE,6] >	;FOR LABEL LATER
MXGP,<
	CAIN T,"X"
	JRST XGPBOX
>;MXGP
	CAIN T,"A"
	CMU,<TRNN FLAG,VERTICAL>	;NOT LEGAL FOR "V" MODE
	TLNE FLAG,TFLG			;NOT LEGAL FOR "V"
	CAIA
	MOVE E,[AW,,AH]
	CAIN T,"B"
	MOVE E,[BW,,BH]
	CAIN T,"C"
	MOVE E,[CW,,CH]
	CAIN T,"D"
	MOVE E,[XWD DW,DH]
	CAIN T,"E"
	MOVE E,[XWD EW,EH]
	CMU,<TRNN FLAG,VERTICAL>	;ARE WE IN VERTICAL MODE?
	TLNE FLAG,TFLG			;DID HE TYPE "V"
	MOVSS E,E			;YES, SWAP X AND Y
	CAIN T,"F"
	JRST [	MOVE T,WIDTH
		XSCALE(T)
		ADDI T,=1000/5
		UNBSCL(T)
		CAIGE T,LABW
		MOVEI T,LABW
		MOVE E,HEIGHT
		XSCALE(E)
		ADDI E,=1000/5
		UNBSCL(E)
		ADDI E,LABH
DEC,<		CAIL T,DLABW		;WILL WE USE NEW TITLE BOX?
		ADDI E,DLABH-LABH	;YES, LEAVE ENOUGH SPACE
>;DEC
		HRL E,T
		JRST NOBRD0]
	CAIN T,"S"
	JRST [	TLNE FLAG,QUICK
		OUTSTR[ASCIZ/X,Y?/]
		TLNN FLAG,QUICK
		OUTSTR[ASCIZ/BOX SIZE (X,Y IN INCHES, DECIMAL POINT ALLOWED.)?/]
		PUSHJ P,MILIN
		CAIE T,","
		JRST [BXERR:PUSHJ P,IERR
			OUTSTR[ASCIZ/INPUT ERROR!
/]
			JRST ASKSIZ]
		UNBSCL(TTT)
		MOVS E,TTT
		PUSHJ P,MILIN
		CAIE T,12
		JRST BXERR
		UNBSCL(TTT)
		HRR E,TTT
		JRST NOBRD0]
	JUMPE E,ASKSIZ
NOBRD0:
DEC,<	HLRE T,E			;GET X BOX SIZE
	CAIL T,DLABW
	JRST [	MOVE T,[DLABW,,DLABH]
		MOVEM T,LABSIZ
		MOVE T,[-DBXLEN,,DBXTAB]
		JRST NOBRDA]
>;DEC
	MOVE T,[LABW,,LABH]			;HEIGHT OF LABELING BOX
	MOVEM T,LABSIZ
	MOVE T,[XWD -BOXLEN,BOXTAB]
NOBRDA:	MOVEM T,BOXPNT
	SETZM BRDPNT
	JUMPE E,NOBRDB
	HLRE T,E
MXGP,<	TRNE FLAG,BXGP				;XGP BOX IS ALREADY OK
	JRST BXGPOK
>;MXGP
	HLRZ TT,LABSIZ
	CAMGE T,TT
	JRST [	OUTSTR[ASCIZ/SORRY, NOT WIDE ENOUGH FOR LABEL BOX!
/]
		JRST ASKSIZ]
LOGO,<	CAIGE T,LOGOW(TT)	;WILL LOGO FIT?
	TLZA FLAG,LOGFLG	;NO, IT WON'T
	TLO FLAG,LOGFLG		;YES, IT WILL!!!
>;LOGO
MXGP,<BXGPOK:>
	BSCALE(T)
	HRLM T,BRDPNT
	HRRE E,E
	BSCALE(E)
	HRRM E,BRDPNT
	HLL E,BRDPNT
NOSPLIT,<
MXGP,<	TRNE FLAG,XGP
	JRST [	HRRZ TTT,E
		CAIG TTT,XGPWID
		JRST NOBRDB
		HLRZ TTT,E
		CAIL TTT,(E)
		JRST NOBRDB
		SETCMM %ROTIT	;COMPLEMENT, RATHER THAN SET, SO HE CAN OVERRIDE US!
		SKIPE %ROTIT
		OUTSTR [ ASCIZ /ROTATING PLOT TO MINIMIZE XGP OUTPUT SPLICING
/]
		JRST NOBRDB ]
>;MXGP
	SKIPE %ROTIT
	JRST [	HRRE TTT,E
		CAIG TTT,PLTWID
		JRST NOBRDB
		OUTSTR[ASCIZ/SORRY, WON'T FIT ROTATED!
/]
		JRST ASK]	;ASK SCALE AGAIN
	HLRE TTT,E
	CAIG TTT,PLTWID
	JRST NOBRDB
	SETOM %ROTIT
	HRRE TTT,E
	CAIG TTT,PLTWID
	JRST [	OUTSTR[ASCIZ/TOO BIG IN X, ROTATING!
/]
		JRST NOBRDB]
	OUTSTR[ASCIZ/TOO BIG IN BOTH X AND Y!
/]
	JRST ASK
>;NOSPLIT

NOBRDB:	SKIPE E,BRDPNT
	JRST NOBRDC
	MOVE E,HEIGHT
	SCALE(E)
	MOVE T,WIDTH
	SCALE(T)
	HRL E,T
NOBRDC:	MOVE T,SMLY
	ADD T,LRGY
	SCALE(T)
	HRRZ TT,LABSIZ
	BSCALE(TT)
	SUB T,TT
	SUBI T,(E)
	ASH T,-1
	TRZ T,1
	MOVEM T,OFFSET		;Y PART OF OFFSET
	MOVE T,LRGX
	ADD T,SMLX
	SCALE(T)
	HLRZ TT,E
	ADD T,TT
	ASH T,-1
	TRZ T,1
	HRLM T,OFFSET		;X PART OF OFFSET
NOSPLIT,<
	SKIPE %ROTIT
	JRST VERTST
	HRRE T,OFFSET
	SUBI T,=1000/5		;START 1 INCH BELOW BOX
	MOVE TT,LRGX
	ADD TT,SMLX
	ASH TT,-1
	SCALE(TT)
	HRL T,TT
	JRST GTSTRT

VERTST:	SKIPN TT,BRDPNT
	JRST NBRDST
	HLRE TTT,OFFSET
	HLRZ TT,TT
	SUBM TTT,TT
	HRRE T,BRDPNT
	ASH T,-1
	ADD T,OFFSET
	SUBI TT,=1000/5		;START 1 INCH BELOW BOX
	HRL T,TT
	JRST GTSTRT

NBRDST:	MOVE T,LRGY
	ADD T,SMLY
	ASH T,-1
	SCALE(T)
	MOVE TT,MINX
	SCALE(TT)
	SUBI TT,=2000/5		;START 2 INCHES BELOW DRAWING
	HRL T,TT
GTSTRT:	MOVEM T,START
	MOVEM T,STOP			;ASSUME STOPPING THERE
	HRREM T,Y
	HLREM T,X
	PUSHJ P,UNFIX
	MOVEM T,CURSE
NODEC,<	MOVE T,START
	SKIPN %ROTIT
	SUB T,[=1000/5,,0]
	SKIPE %ROTIT
	SUBI T,=1000/5
	MOVEM T,RSTART
>;NODEC
MXGP,<	TRNN FLAG,XGP			;DON'T REPOSITION ON XGP!!!!>
	TRNN FLAG,%DOPLT	;PLOTTING?
	JRST NOSTOP
	TRNN FLAG,PRODUCE
	SKIPE PARG
	JRST STSTOP
	TRNN FLAG,REPOS
	JRST NOSTOP
STSTOP:	HRRE T,BRDPNT
	JUMPN T,STSTO1
	MOVE T,HEIGHT
	SCALE(T)
STSTO1:	ADD T,OFFSET
	TLZ T,1
	SKIPN %ROTIT
	JRST [	ADDI T,=1000/5		;STOP AN INCH ABOVE BOX
		HLL T,START		;STOP AT SAME X
		JRST GTSTOP]
	ADD T,[XWD =1000/5,0]
	HRR T,START			;SAME Y
GTSTOP:	MOVEM T,STOP
>;NOSPLIT
NOSTOP:
FOR I IN(SMLX,SMLY,LRGX,LRGY)
<	MOVE T,I
	SCALE(T)
	MOVEM T,I
>
NODEC,<	TLNE FLAG,SIMBOX
	JRST [	SETZ A,
		JRST ISSIM]
>;NODEC
	MOVEI A,=500/5		;SIZE OF EXTRA BORDER
	BSCALE(A)
ISSIM:	HRRE T,OFFSET		;OFFSET IS LOWER RIGHT (MIN Y, MAX X)
	SUB T,A
	CAMGE T,SMLY
	MOVEM T,SMLY
	HLRE TT,OFFSET
	ADD TT,A
	CAMLE TT,LRGX
	MOVEM TT,LRGX
	ASH A,1			;DOUBLE TO FUDGE OTHER DIRECTION
	HRRE TTT,BRDPNT
	ADD T,TTT
	ADD T,A
	CAMLE T,LRGY
	MOVEM T,LRGY
	HLRE TTT,BRDPNT
	SUB TT,TTT
	SUB TT,A
	CAMGE TT,SMLX
	MOVEM TT,SMLX
	POPJ P,

NODEC,<
ASKSIG:	SETZM SIGNAM		;NONE YET!
MXGP,<	TRC FLAG,XGP!PRODUCE
	TRCN FLAG,XGP!PRODUCE	;NO SIGNATURE ON XGP WITH XGP BOX
	POPJ P,
>;MXGP
	MOVSI T,EXTSIG
	PUSHJ P,SETIT
	POPJ P,
	MOVE T,FILNAM
	MOVEM T,SIGNAM
	MOVE T,FILEXT
	MOVEM T,SIGNAM+1
	MOVE T,FILPPN
	MOVEM T,SIGNAM+2
	INIT SIG,0
	'DSK   '
	0
	JRST [	OUTSTR[ASCIZ/CAN'T GET DSK FOR SIG FILE!
/]
		EXIT 1,
		JRST .-3]
	LOOKUP SIG,FILNAM
	JRST [
IFN DATPPN,<	SKIPE T,SIGNAM+2
		JRST NOSIGX
		DSKPPN T,
		CAMN T,[DATPPN]
		JRST NOSIGX
		MOVE T,[DATPPN]
		MOVEM T,SIGNAM+2
		MOVEM T,FILPPN
		JRST .-1
	NOSIGX:
>;IFN DATPPN
		OUTSTR[ASCIZ/CAN'T FIND THE SIGNATURE!
/]
		RELEASE SIG,
		JRST ASKSIG]
	RELEASE SIG,
	POPJ P,
>;NODEC
;BOX SUBR(D)
OUTDON:
	PUSHJ P,FORCE
	SKIPN BRDPNT
	JRST NOBRD
DEC,<	GETLN T,
	TLNE T,-1
>;DEC
	OUTSTR[ASCIZ/DOING BOX!
/]
	MOVE T,OFFSET		;START WITH OFFSET
	MOVEI D,3
	PUSHJ P,STUFXY		;INVIS TO LOWER RIGHT-STUFXY DOESN'T USE OFFSET
	PUSHJ P,PLOTIT		;PLOTIT CHECKS FR80 ,CALLS PLOT IF DOPLT IS TRUE
	HLLZ T,BRDPNT
	MOVN T,T		;T HAS -WIDTH OF PLOT BOUNDARY
	MOVEI D,2
	PUSHJ P,STUFAD		;VIS TO LOWER LEFT-STUFAD USES OFFSET
	PUSHJ P,PLOTIT
	HLLZ T,BRDPNT
	MOVN T,T
	HRR T,BRDPNT
	PUSHJ P,STUFAD		;VIS TO UPPER LEFT
	PUSHJ P,PLOTIT
	HRRZ T,BRDPNT
	PUSHJ P,STUFAD		;VIS TO UPPER RIGHT
	PUSHJ P,PLOTIT
	MOVE T,OFFSET
	PUSHJ P,STUFXY		;BACK TO START
	PUSHJ P,PLOTIT
LOGO,<
	TLNN FLAG,LOGFLG
	JRST NOLOG
	MOVE E,[-LOGLEN,,LOGTAB]	;DO THE CMU LOGO!
LOGLOP:	MOVE T,(E)
	MOVEI D,2
	TRZE T,1
	MOVEI D,3		;REALLY INVISIBLE
	PUSHJ P,BFIXXY
	PUSHJ P,PLOTIT
	AOBJN E,LOGLOP
NOLOG:
>;LOGO
	MOVE E,BOXPNT		;GET BOX POINTER
BRDLOP:	MOVE T,(E)
	MOVEI D,2
	TRZE T,1
	MOVEI D,3		;REALLY INVISIBLE
	PUSHJ P,BFIXXY
	PUSHJ P,PLOTIT
	AOBJN E,BRDLOP
BSLOP:	MOVE T,1(E)		;LOC OF THIS THING
	PUSHJ P,BFIXXY
	XCT (E)			;CALL ROUTINE (WILL LEAVE WITH JRST)
	ADDI E,2
	JRST BSLOP		;CONTINUE UNTIL DISP IS JRST

FINBOX:
NODEC,<	TLNE FLAG,SIMBOX
	JRST NOBRD		;THESE TURKEYS DON'T WANT GRID
>;NODEC
	PUSHJ P,FANCY
	PUSHJ P,OUTER		;ALWAYS DO OUTSIDE BOX
DEC,<	TLNN FLAG,SIMBOX
	PUSHJ P,ECOBOX		;NO ECO BOXES IF SIMPLE
>;DEC
	JRST NOBRD
;GRID LABELING BOX SUBR(D)
LNSIZE__6
FANCY:	HRRE T,BRDPNT
	HRRZ TT,LABSIZ
	BSCALE(TT)
	SUB T,TT
	MOVEM T,YVAL
	HLRE T,BRDPNT
	MOVEM T,XVAL
;NOW ALONG BOTTOM
	MOVNI T,CWIDTH*LNSIZE/2
	BSCALE(T)
	MOVE TT,XVAL
	ASH TT,-4
	SUB T,TT
	HRLZM T,LSTBOX
	MOVNI T,<=500/5+CHGHT*LNSIZE>/2
	BSCALE(T)
	HRRM T,LSTBOX
	MOVN C,XVAL
	ASH C,-3
	HRLZ C,C
DEFINE DOLET(LETTER)
<	MOVE T,LSTBOX
	PUSHJ P,STUFAD
	MOVSI A,(<ASCII/LETTER/>)
	PUSHJ P,PUTLET
	ADDM C,LSTBOX
>
	MOVNI T,=500/5
	BSCALE(T)
	HRLZM T,STUBXY
DEFINE DOSTUB(INC)
<	MOVNI A,INC
	PUSHJ P,VSTUB
>
	DOLET(1)
	DOSTUB(2)
	DOLET(2)
	DOSTUB(4)
	DOLET(3)
	DOSTUB(6)
	DOLET(4)
	DOSTUB(8)
	PUSHJ P,DIMPLV
	DOLET(5)
	DOSTUB(=10)
	DOLET(6)
	DOSTUB(=12)
	DOLET(7)
	DOSTUB(=14)
	DOLET(8)
   