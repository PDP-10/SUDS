TITLE SPLIT

XALL
NOLIT

DEFINE VERSION ' (V) <V'1>
VERSION VSPLIT__
VERSION SUBTTL SPLIT V

IFDEF SPWBUT,<DECSW__0;>DECSW__-1
DEFINE DEC<IFN DECSW>
DEFINE NODEC<IFE DECSW>

DEFINE NOVIROS<VIROSSW__0
PRINTS /NON-VIROS VERSION SELECTED
/>

PRINTS /TYPE	TO GET
NOVIROS	NON-VIROS VERSION

END WITH ^Z
/
.INSERT TTY:
NODEC,<VIROSSW__0>
IFNDEF VIROSSW,<VIROSSW__-1>
DEFINE VIROS<IFN VIROSSW>
DEFINE NOVIROS<IFE VIROSSW>

VIROS,<
SEARCH STENEX
>;VIROS
OPDEF GETTAB[CALLI 41]

;AC DEFINITIONS
A_1
B_2
C_3
D_4
E_5
F_6

I_12

T_13
TT_T+1
TTT_TT+1
SP_16
P_17

;AC 0 FLAG BITS
ASK__1		;ASK ABOUT EACH FILE IN DIRLOP
REDEF__2	;REDEFINING EXISTING PLOTTER
FITFUL__4	;SET IF PLOT WILL FIT ON FULL PLOTTER

;BIT DEF FOR DEVTYP UUO
TY.MAN__400000		;LOOKUP ENTER MANDATORY

;SPECIAL VALUES
ALTMOD__33		;DEC ALTMODE
CHRSTP__=50		;INTENDED SIZE OF ONE CHARACTER STEP

;SPACE AT DRAWING EDGES
EDGET__=5000		;1/2 INCH AT TOP
EDGEB__=5000		;1/2 INCH AT BOTTOM
	EDGEID__=2500	;1/4 INCH BELOW PLOT FOR PLOT ID
EDGEW__=5000		;1/2 INCH BETWEEN PLOTS HORIZONTALLY

;WIDTH OF SMALLEST CHARACTER IN PLOTTER STEPS
NODEC,<CWIDTH__10>
DEC,<CWIDTH__6>

;IO CHANNELS
DIRCHN__0
DATCHN__1
TMPCHN__2

PLTCHN__17	;PLOTTER CHANNEL (SAME AS IN PLOTS)

EXTERNAL PLOTS,PLOT,SETXY,SYMBOL,WHERE,REF,.JBREL,VPLOTS,.JBFF
INTERNAL DOPLT

VMAJOR__1	;MAJOR VERSION #
VMINOR__0	;MINOR VERSION LETTER
VGROUP__2	;MODIFYING GROUP

ORG	137
	<BYTE (3) VGROUP (9) VMAJOR (6) VMINOR>+VPLOTS+VSPLIT
ORG

DOPLT:	REF

EXTPLO__<'PLO'>
EXTPCO__<'PCO'>
PDLLEN__40

;DATA FILE INPUT BLOCK CODES
DEFINE CODES
<	CODMAC	NOP,0
	CODMAC	MM,2
	CODMAC	VEC,1
	CODMAC	SYM,1
>

DEFINE CODMAC $ (A,B)
<MAXCOD__MAXCOD+1
A$COD__MAXCOD
A$NUM__B
>

MAXCOD__-1

CODES
;DATA AREA
DEFINE DATA(ADDR,SIZE)
<ADDR:
IFIDN<SIZE><><BLOCK 1>
IFDIF<SIZE><><BLOCK SIZE>
>


DATA	PDL,PDLLEN
DATA	DIRHD,3
DATA	DATHD,3

DATA	MAXX
DATA	MAXY
DATA	MINX
DATA	MINY

DATA	INSTEP
DATA	ROTIT
DATA	PLTDEV
DATA	DIRLST
DATA	LOGDEV
DATA	PHYDEV
DATA	WAIT
DATA	SKPFLG
DATA	SAVFF
DATA	SPACEW
DATA	SPACEH
DATA	LASTW
DATA	LASTH
DATA	CHRCNT
;PLOTTER TABLES

DEC,<
NOVIROS,<
DEFINE PLOTTERS
<	PMAC	PLT0,280000,50,CALCOMP
	PMAC	PLT1,347500,25,HOUSTON
	PMAC	PL20,347500,25,HOUSTON
>
>;NOVIROS

VIROS,<
DEFINE PLOTTERS
<	PMAC	PPLT0,347500,25,HOUSTON
	PMAC	PPLT1,347500,25,HOUSTON
>
>;VIROS
>;DEC

NODEC,<
DEFINE PLOTTERS
<	PMAC	PTP,280000,50,CALCOMP
>
>;NODEC

DEFINE PMAC(LOG,WID,STEP,NAME)
<	SIXBIT/LOG/
>

LOGNAM:	PLOTTERS
NPLT__.-LOGNAM
	0

DEFINE PMAC(LOG,WID,STEP,NAME)
<	=WID
>

WIDTH:	PLOTTERS
	0

DEFINE PMAC(LOG,WID,STEP,NAME)
<	=STEP
>

STEPS:	PLOTTERS
	0

DEFINE PMAC(LOG,WID,STEP,NAME)
<	[ASCIZ/NAME/]
>

PNAMES:	PLOTTERS
	[ASCIZ/HOME BREW/]


DEFINE SCALE(AC)
<	IMUL AC,INSTEP
	IDIV AC,STEPS(I)
>

DEFINE DETCHK(AC,ISDET)
<	CALLI AC,34
	TLNN AC,-1
	JRST ISDET
>
STRT:	CALLI
	MOVE P,[IOWD PDLLEN,PDL]
	SETZ 0,		;CLEAR FLAGS
	MOVE T,.JBFF
	CALLI T,11	;MAYBE SHRINK CORE
	JFCL		;IGNORE ERROR
	OPEN DIRCHN,[13
		'DSK   '
		DIRHD]
	JRST DSKERR
	INBUF DIRCHN,1
	OPEN DATCHN,[13
		'DSK   '
		DATHD]
	JRST DSKERR
	INBUF DATCHN,2
	JRST ASKPLT

DSKERR:	OUTSTR[ASCIZ/MOBY FOO, I CAN'T OPEN THE DISK.
/]
	EXIT 1,
	JRST STRT

TELPLT:	OUTSTR[ASCIZ/AVAILABLE PLOTTERS:
NAME	WIDTH	STEP(MILS)
/]
	MOVSI I,-NPLT
PLOP:	MOVE TT,LOGNAM(I)
	PUSHJ P,SIXOUT
	OUTCHR[11]
	MOVE T,WIDTH(I)
	IDIVI T,=10000
	PUSHJ P,DECOUT
	OUTCHR ["."]
	MOVE T,WIDTH(I)
	IDIVI T,=10000
	MOVE T,TT
	IDIVI T,=10
	IDIVI T,=100
	IDIVI TT,=10
	ADDI T,60
	OUTCHR T
	ADDI TT,60
	OUTCHR TT
	ADDI TTT,60
	OUTCHR TTT
	OUTSTR[ASCIZ/"	  /]
	MOVE T,STEPS(I)
	PUSHJ P,STPOUT
	OUTCHR[11]
	OUTSTR @PNAMES(I)
	OUTSTR[ASCIZ/
/]
	AOBJN I,PLOP
	OUTSTR[ASCIZ/OR ANY OTHER PLOTTER YOU WANT
(YOU MUST TELL ME THE CHARACTERISTICS).
/]
ASKPLT:	OUTSTR[ASCIZ/PLOTTER NAME (<CR> FOR LIST)?/]
	PUSHJ P,GETWRD
	TRZ REDEF
	CAIN TTT,12
	JRST PLTOK
	CAIE TTT,ALTMOD
	JRST ILLPLT
	TRO REDEF
	OUTSTR[ASCIZ/
/]
PLTOK:	JUMPE T,TELPLT
	MOVEM T,LOGDEV		;FOR LOOKUP
	CALLI T,64		;GET PHYSICAL NAME
	JRST [	OUTSTR[ASCIZ/NO SUCH DEVICE!
/]
		JRST ASKPLT]
	MOVEM T,PHYDEV		;SAVE FOR LATER
	CAMN T,LOGDEV
	JRST ISPHYS
	MOVE TT,LOGDEV
	PUSHJ P,SIXOUT
	OUTSTR[ASCIZ/ = /]
	MOVE TT,PHYDEV
	PUSHJ P,SIXOUT
	OUTSTR[ASCIZ/
/]
ISPHYS:	TRNE REDEF
	JRST [	MOVEI I,NPLT
		JRST NEWPLT]
	MOVE T,LOGDEV		;SEARCH FOR LOGICAL NAME FIRST
	MOVSI I,-NPLT
	CAME T,LOGNAM(I)
	AOBJN I,.-1
	JUMPL I,GOTPLT		;DID WE FIND LOGICAL NAME?
	MOVE T,PHYDEV		;NO, GET PHYSICAL NAME
	CAMN T,LOGDEV		;PHYSICAL NAME DIF FROM LOGICAL NAME?
	JRST NEWPLT
	MOVSI I,-NPLT
	CAME T,LOGNAM(I)
	AOBJN I,.-1
	JUMPL I,GOTPLT
NEWPLT:	MOVEM T,LOGNAM(I)	;PREPARE TO MAKE ONE
	OUTSTR[ASCIZ/TELL ME ABOUT IT:
WIDTH (IN INCHES):/]
	PUSHJ P,DECIN
	JRST ILLPLT
	JUMPE T,ILLPLT
	IMULI T,=10000
	CAIE TTT,"."
	JRST NOPER
	MOVEI TT,=1000
PERLOP:	PUSHJ P,GETCHR
	CAIL TTT,"0"
	CAILE TTT,"9"
	JRST NOPER
	SUBI TTT,60
	IMUL TTT,TT
	ADD T,TTT
	IDIVI TT,=10
	JRST PERLOP

NOPER:	CAIE TTT,12
	JRST ILLPLT
	MOVEM T,WIDTH(I)
	OUTSTR[ASCIZ/STEPS SIZE (IN MILS, 1 DIGIT AFTER DECIMAL POINT OK):/]
	PUSHJ P,DECIN
	JRST ILLPLT
	MOVE A,T
	SETZ T,
	CAIE TTT,"."
	JRST NOPOINT
	PUSHJ P,GETCHR
	CAIL TTT,"0"
	CAILE TTT,"9"
	JRST NOPOINT
	MOVEI T,-60(TTT)
	PUSHJ P,GETCHR
NOPOINT:CAIE TTT,12
	JRST ILLPLT
	IMULI A,=10
	ADD T,A
	MOVEM T,STEPS(I)
GOTPLT:	HRRZ I,I
	MOVEI T,CHRSTP
	IDIV T,STEPS(I)
	JUMPE TT,.+2
	OUTSTR[ASCIZ/CHARACTER STEP NOT MULTIPLE OF PLOTTER STEP.
/]
	JUMPN T,FILES
	OUTSTR[ASCIZ/THIS PLOTTER MAY LOSE ON SIZE 1 TEXT!
/]
	JRST FILES

ILLPLT:	PUSHJ P,IERR
	JRST ASKPLT

DECOUT:	IDIVI T,=10
	HRLM TT,(P)
	SKIPE T
	PUSHJ P,DECOUT
	HLRZ TT,(P)
	ADDI TT,60
	OUTCHR TT
	POPJ P,

STPOUT:	IDIVI T,=10
	HRLM TT,(P)
	PUSHJ P,DECOUT
	OUTCHR["."]
	HLRZ T,(P)
	JRST DECOUT

GETWRD:	SETZ T,
	MOVE TT,[POINT 6,T]
	PUSHJ P,SKPSPA
	CAIA
GET1:	PUSHJ P,GETCHR
	CAIGE TTT,"0"
	JRST SKPSPB
	CAIL TTT,140
	SUBI TTT,40
	CAILE TTT,"Z"
	JRST SKPSPB
	CAILE TTT,"9"
	CAIL TTT,"A"
	CAIA
	JRST SKPSPB
	SUBI TTT,40
	TLNE TT,770000
	IDPB TTT,TT
	JRST GET1

YORN:	OUTCHR["?"]
	PUSHJ P,GETCHR
	CAIN TTT,"Y"
	AOS (P)
	MOVE TT,TTT
YORN1:	CAIN TTT,ALTMOD
	JRST [	OUTSTR[ASCIZ/
/]
		POPJ P,]
	CAIN TTT,12
	POPJ P,
	PUSHJ P,GETCHR
	JRST YORN1

GETCHR:	INCHWL TTT
	CAIN TTT,15
	JRST GETCHR
	CAIL TTT,140
	SUBI TTT,40
	CAIN TTT,11
	MOVEI TTT,40
	POPJ P,

SKPSPA:	PUSHJ P,GETCHR
SKPSPB:	CAIN TTT,40
	JRST SKPSPA
	POPJ P,

DECIN:	SETZ T,
	PUSHJ P,SKPSPA
	CAIL TTT,"0"
	CAILE TTT,"9"
	POPJ P,
	AOS (P)
DECIN1:	ADDI T,-60(TTT)
	PUSHJ P,GETCHR
	CAIL TTT,"0"
	CAILE TTT,"9"
	JRST SKPSPB
	IMULI T,=10
	JRST DECIN1
DEFINE COMS
<	COMMAC	"H",FHELP,<H	TYPE THIS LIST>
	COMMAC	12,GETALL,<<CR>	PLOT ALL FILES WITH EXTENSION 'PLO'>
	COMMAC	"A",AUTO,<A	AUTOMATIC MODE, WAIT IN LOOP FOR FILES>
	COMMAC	"S",GETSEL,<S	SELECT FILES WITH EXTENSION 'PLO'>
	COMMAC	"T",TYPE,<T	YOU TYPE A LIST OF FILES>
	COMMAC	"P",POSIT,<P	POSITION PLOTTER PEN TO FAR RIGHT>
	COMMAC	"E",LEAVE,<E	EXIT>
	COMMAC	"N",ASKPLT,<N	RE-SELECT PLOTTER>
>

DEFINE COMMAC(A,B,C)
<	A,,B
>

COMTAB:	COMS
COMLEN__.-COMTAB
	0,,COMERR

DEFINE COMMAC(A,B,C)
<	[ASCIZ/C
/]
>

COMTXT:	COMS

FHELP:	OUTSTR[ASCIZ/CHAR	EFFECT
/]
	MOVSI T,-COMLEN
FHELP1:	OUTSTR @COMTXT(T)
	AOBJN T,.-1
FILES:	OUTSTR[ASCIZ/FILE MODE (H FOR HELP):/]
	PUSHJ P,GETCHR
	MOVE A,TTT
	CAIE A,12
	PUSHJ P,GETCHR
	CAIE TTT,12
	JRST [	PUSHJ P,IERR
		JRST FILES]
	MOVSI T,-COMLEN
COMLOP:	HLRZ TT,COMTAB(T)
	CAME TT,A
	AOBJN T,COMLOP
	HRRZ T,COMTAB(T)
	JRST (T)

POSIT:	PUSHJ P,SETPLT			;INIT PLOTTER
	MOVE A,WIDTH(I)
	ADDI A,=100000			;FUDGE BY 10 INCHES
	IDIV A,STEPS(I)			;GET PLOTTER WIDTH IN STEPS
	SETZ B,
	MOVNI C,3
	JSA SP,PLOT			;DRIVE PEN HARD TO RIGHT
	JUMP A
	JUMP B
	JUMP C
	MOVEI T,=1000			;NOW MOVE BACK 1/10 INCH IN CASE OF EDGE ERROR
	IDIV T,STEPS(I)
	SUB A,T
	JSA SP,PLOT
	JUMP A
	JUMP B
	JUMP C
	RELEASE PLTCHN,
	JRST FILES

COMERR:	OUTSTR[ASCIZ/UNKNOWN COMMAND!
/]
	JRST FILES

LEAVE:	CALLI 12

TYPE:	OUTSTR[ASCIZ/TYPE LIST OF FILES SEPERATED BY COMMAS:
/]
	MOVE F,.JBFF
	MOVEM F,DIRLST
SCNLOP:	PUSHJ P,SCAN
	JRST FILES
	PUSHJ P,FILPUT
	CAIN TTT,12
	JRST SCNFIN
	JRST SCNLOP

AUTO:	OUTSTR[ASCIZ/AUTO MODE TEMPORARILY UNAVAILABLE.
WILL PLOT ALL CURRENTLY EXISTING FILES.
/]
	JRST GETALL
;REMOVE PREVIOUS 2 INSTRUCTIONS TO REVIVE AUTO MODE
	TRZ ASK
	SETOM WAIT
	PUSHJ P,DODIR
	SKIPGE F,DIRLST
	JRST GOTFL0		;GO DO FILES
AUTOS:	MOVEI T,30
	CALLI T,31
	JRST AUTO

GETALL:	TRZA ASK
GETSEL:	TRO ASK
	PUSHJ P,DODIR		;FIGURE OUT WHICH FILES
GOTFIL:	SETZM WAIT
	SKIPL F,DIRLST
	JRST FILES
GOTFL0:	DETCHK T,GOTFL1
	OUTSTR[ASCIZ/PROCESSING:
/]
GOTFL1:	PUSHJ P,DOLOP		;DO THEM
	RELEASE PLTCHN,
	SKIPE SKPFLG		;DID WE SKIP ANY IN AUTO MODE?
	JRST AUTOS		;YES, WAIT BEFORE RESCANNING UFD
	SKIPE WAIT
	JRST AUTO
	DETCHK T,LOGOUT
	JRST FILES

LOGOUT:	MOVE TT,LOGDEV	;PREPARE TO GIVE BACK PLOTTER
	SETZ T,			;TO JOB 0 (DEASSIGN)
	CALLI T,21
VIROS,<
	SETO 1,
	LGOUT		;BYE
>;VIROS
NOVIROS,<
	MOVE T,[3,,KJOBLK]
	CALLI T,44		;TMPCOR UUO
	JRST [	OUTSTR[ASCIZ/FAILED TO WRITE TMP:KJOB!
/]
		CALLI 12]
	MOVE T,[1,,LOGO]
	CALLI T,35		;RUN UUO
	OUTSTR[ASCIZ/RUN UUO FAILURE ON SYS:KJOB!
/]
	CALLI 12

KJOBLK:	'KJO',,0
	IOWD BUFLEN,KJOSTR

KJOSTR:	ASCIZ \KJOB NUL:=/F
\
BUFLEN__.-KJOSTR

LOGO:	'SYS   '
	'KJOB  '
	0		;DEF EXT
	0
	0		;PPN
	0		;DEF CORE
>;NOVIROS

SCNFIN:	MOVEM F,SAVFF
	SUB F,DIRLST
	MOVN F,F
	HRLM F,DIRLST
	JRST GOTFIL

OSCAN:	SKIPA B,['PLT   ']
SCAN:	MOVSI B,EXTPLO
	SETZ A,
	CALLI D,24
	PUSHJ P,GETWRD
	JUMPE T,[CAIN TTT,12
		POPJ P,
		JRST IERR]
	MOVE A,T
	CAIE TTT,"."
	JRST GETPPN
	PUSHJ P,GETWRD
	HLLZ B,T
GETPPN:	CAIE TTT,"["
	JRST SCNEND
	PUSHJ P,INPPN
	JRST IERR
	CAIN TTT,"]"
	JRST GOTPN
	HRL D,T
	CAIE TTT,","
	JRST IERR
	PUSHJ P,INPPN
	JRST IERR
GOTPN:	HRR D,T
	SETZ T,
	CAIN TTT,"]"
	PUSHJ P,GETWRD
	JUMPN T,IERR
SCNEND:	CAIE TTT,","
	CAIN TTT,12
	JRST CPOPJ1
IERR:	CAIE TTT,ALTMOD
	CAIN TTT,12
	JRST IERR1
	PUSHJ P,GETCHR
	JRST IERR

IERR1:	CAIE TTT,ALTMOD
	OUTSTR[ASCIZ/???/]
	OUTSTR[ASCIZ/
/]
	POPJ P,

INPPN:	PUSHJ P,OCTIN
	JUMPE T,CPOPJ
	CAIG T,777777
	AOS (P)
	POPJ P,

OCTIN:	SETZ T,
OCTIN1:	PUSHJ P,GETCHR
	CAIL TTT,"0"
	CAILE TTT,"7"
	POPJ P,
	ASH T,3
	ADDI T,-60(TTT)
	JRST OCTIN1
DODIR:	SETZM DIRLST
	CALLI A,24		;GETPPN
	MOVSI B,'UFD'
	SETZ C,
	MOVE D,[1,,1]
	LOOKUP DIRCHN,A
	JRST [	OUTSTR[ASCIZ/LOOKUP FAILED ON UFD!
/]
		POPJ P,]
	MOVE F,.@	%-4AY	%%'($wI'(A/=%A/%A<A%)I
AM=+)')I7'%4_)3A
A2AQA!=(XAˆ)A	)Š0A3QŽ'Š)A'- \(_:%@t!+MA 1)	%$)%'(A%	8=-
A‚1))((!+'!A Y)	HI'(A	%%	4+5!
A‚1	%= !4AY))(45
AYm1)!1XXatA„171)AXXA:(%'PA	%1 %$AXdP)IAM)%'(A9'4Y
A)¨1A+'” Y'a+((+)%6D8E:%-Š)(Y4!+MA 1'1U(1+@A	)Y$w=+ A
\4%M(A6=+)')I7'%4_=+ AXA
@z@=:%%%´(Y(!+MA 1)U(%+)'Q%7'4^(_:$%'PA	%1!:(+)%6bE:M)4AQ(XA)ˆh!+'!A Y)0I'(A9	(-A(Y)Q(=+)')HA(%)%Š))(XLnl%%'¨!)t'Š	)!X%!+'(A Y3=%%%'¨	='t%')´X$wA+%%9(A%XA(A!!8AXdh(!+'!A Y!+PI'(A	%% 4!	˜hA)(X	D%%'¨	%= wM AQ&A
(')iAY%Š	)!Y(%'PA6U)')%m'h_	)
Aˆ0A	@z@_t!%%4APY$!+'!A Y=)+P=+)')I7'%4^=:%%'¨	%=!:%%'¨	%= )	%	=t1'
A%8X5-šY'Y%'+AY	%1'(%-œY(%4AY	%%'(4!AA X4'%1+¨h+A
A)¨1!!(')4A¨0MA¨0l		APXh`(+)$A(4%M(A'a+(('%1+¨i%´(Y())U(t-APXb`(%4A)(X! R%'!A(%!+'(A Y)+(4I4A)¨0Q R(		$A)(XX`=+)HA)()!!(t!AA X4)	¤h''A	%!Vd(A%8X)%'(A%4	QAQ)(YA!(')QA	IXEdd(+)M)%7M4_%!+¨%%HAA%Q%2A
B4_:(!!(A X(	It%	AQ)(Y	%%VD!=!bt%&@! R%!!” X4A+(tA+'” Y1$(-AX!R%-4AXb!R%-4AXd!R%		’Xf(!!(A X(1$t%-$A(Xd!R%Ž(X]	%(!!(A X(1A(XDb(!!(A X(+)M)%7M4_hA(A=%
A=$A1
AM(B=:’ bXbd4%M(A1$(w-
AAA))$A%+8	1!.t%-$A(Xf@APXfb$w/PAA%))Š/'Q!(t%')54A'!m-8O(A'-!!A²3((-A(Y=	,
	MOVEM T,PLTDEV
	JSA SP,PLOTS
	JUMP PLTDEV
	SKIPE PLTDEV
	JRST SETPL1
	MOVEI T,PLTCHN		;CHANNEL USED BY PLOTS
	DEVTYP T,
	POPJ P,			;OH WELL...
	TLNN T,TY.MAN		;NEED ENTER?
	POPJ P,			;NO
SETPL2:	OUTSTR[ASCIZ/FILE NAME FOR PLOTTER OUTPUT?/]
	PUSHJ P,OSCAN		;SCAN OUTPUT FILE NAME
	JRST SETPL2
	CAIE TTT,12
	JRST [	PUSHJ P,IERR
		JRST SETPL2]
	HLLZS B
	SETZ C,
	ENTER PLTCHN,A		;ENTER FILE
	JRST [	OUTSTR[ASCIZ/ENTER FAILED, CODE = /]
		HRRZ T,B
		PUSHJ P,OCTOUT
		OUTSTR[ASCIZ/
/]
		JRST SETPL2]
	POPJ P,

SETPL1:	DETCHK T,DOLOPW
	MOVE TT,LOGDEV
	PUSHJ P,SIXOUT
	OUTSTR[ASCIZ/ (/]
	MOVE TT,PHYDEV
	CAMN TT,LOGDEV
	JRST NODIF
	PUSHJ P,SIXOUT
	OUTCHR[":"]
NODIF:	OUTSTR @PNAMES(I)
	OUTSTR[ASCIZ/) NOT AVAILABLE!
WAITING.
/]
	JRST DOLOPW

DOLOP:	PUSHJ P,SETPLT
	MOVE T,WIDTH(I)
	MOVEM T,SPACEW
	SETZM SPACEH
	SETZM LASTW
	SETZM LASTH
	JRST DOLOP1

DOLOP0:	ADD F,[3,,3]
	JUMPGE F,FPARK
DOLOP1:	PUSHJ P,DOFILE
	JRST DOLOP0
NOVIROS,<
	OPEN TMPCHN,[17
		'DSK   '
		0	]
	JRST DOLOPD		;LET ERROR HAPPEN LATER
	MOVE A,PHYDEV
	MOVSI B,'FIN'
	SETZB C,D
	LOOKUP TMPCHN,A
	JRST DOLOPD		;LET ERROR HAPPEN ON RENAME
	SETZ A,
	SETZB C,D
	RENAME TMPCHN,A		;DELETE OLD FILE
	JFCL
DOLOPD:	RELEASE TMPCHN,
>;NOVIROS
	MOVE A,PHYDEV	;USE PHYSICAL DEVICE NAME FOR FILENAME
	MOVSI B,'FIN'
	SETZB C,D		;MOVE TO CURRENT AREA
	RENAME DATCHN,A		;RENAME FILE
	JRST DOLOP2
	CLOSE DATCHN,
VIROS,<	GJINF		;GET CONNECTED DIR NUM INTO 2
	MOVE 1,2
	DELDF		;EXPUNGE FILES
>;VIROS
	JRST DOLOP0

DOLOP2:	DETCHK T,DOLOP0
	OUTSTR[ASCIZ/RENAME FAILED, CODE = /]
	HRRZ T,B
	PUSHJ P,OCTOUT
	OUTSTR[ASCIZ/
/]
	JRST DOLOP0

FPARK:	MOVE A,WIDTH(I)
	SUB A,SPACEW
	ADD A,LASTW
	IDIV A,STEPS(I)
	MOVE B,SPACEH
	ADD B,LASTH
	IDIV B,STEPS(I)
	MOVNI C,3
	JSA SP,PLOT		;WILL CLOSE FILE IF ANY
	JUMP A
	JUMP B
	JUMP C
	POPJ P,
INTFIL:	MOVE A,(F)
	MOVE B,1(F)
	SETZ C,
	MOVE D,2(F)
	LOOKUP DATCHN,A
	JRST [	DETCHK T,CPOPJ
		OUTSTR[ASCIZ/LOOKUP FAILED, CODE = /]
		HRRZ T,B
		PUSHJ P,OCTOUT
		OUTSTR[ASCIZ/
/]
		CLOSE DATCHN,
		POPJ P,]
	LDB T,[POINT 3,C,2]	;GET USER PROTECTION BITS
	SKIPE WAIT		;ARE WE IN AUTO MODE?
	CAIG T,1		;YES, CAN I DELETE IT LATER
	JRST DELOK		;YES, GO ON
	SETOM SKPFLG		;FLAG WE SKIPPED ONE
	DETCHK T,CPOPJ
	OUTSTR[ASCIZ/NOT PROCESSING IN AUTO MODE
BECAUSE I CAN'T DELETE IT LATER.
/]
	CLOSE DATCHN,
	POPJ P,

DELOK:	DETCHK T,CPOPJ1
	JRST CPOPJ1

DOFILE:	MOVE T,SAVFF
	HRRM T,TXTPNT
	DETCHK T,DOLOOK
	MOVE TT,(F)
	PUSHJ P,SIXOUT
	OUTCHR["."]
	HLLZ TT,1(F)
	PUSHJ P,SIXOUT
	SKIPN 2(F)
	JRST NOFPPN
	OUTCHR["["]
	HLLZ T,2(F)
	PUSHJ P,LSIXOUT
	OUTCHR[","]
	HRLZ T,2(F)
	PUSHJ P,LSIXOUT
	OUTCHR["]"]
NOFPPN:	OUTCHR[11]
DOLOOK:	PUSHJ P,INTFIL		;INIT DISK AND LOOKUP FILE
	POPJ P,			;LOSSAGE
SKPID:	PUSHJ P,GETFIL
	JRST FORMEE
	TRNE TTT,376
	JRST SKPID
	JRST LOOKOK

;READ MAX/MIN BLOCK FROM FILE FIRST
VECSKP:	MOVEI T,VECNUM
VECSK1:	PUSHJ P,GETFIL
	JRST FORMEE
	SOJG T,VECSK1
NOPSKP:
LOOKOK:	PUSHJ P,GETFIL
	JRST FORMEE
	HRRZ T,TTT
	CAILE T,MAXCOD
	JRST FORMEE
	JRST @SKPTAB(TTT)

SYMSKP:	MOVEI T,SYMNUM
SYMSK1:	PUSHJ P,GETFIL
	JRST FORMEE
	SOJG T,SYMSK1
SYMSK2:	PUSHJ P,GETFIL
	JRST FORMEE
	TRNE TTT,376
	JRST SYMSK2
	JRST LOOKOK

DEFINE CODMAC $ (A,B)
<	A$SKP
>

SKPTAB:	CODES

MMSKP:	HLRZM TTT,INSTEP
	PUSHJ P,GETFIL
	JRST FORMEE
	HLRE T,TTT
	SCALE(T)
	MOVEM T,MINX
	HRRE T,TTT
	SCALE(T)
	MOVEM T,MAXX
	PUSHJ P,GETFIL
	JRST FORMEE
	HLRE T,TTT
	SCALE(T)
	MOVEM T,MINY
	HRRE T,TTT
	SCALE(T)
	MOVEM T,MAXY
FITAGN:	SETZM ROTIT		;ASSUME UPRIGHT
	TRZ FITFUL
	MOVE T,MAXX
	SUB T,MINX
	IMUL T,STEPS(I)
	CAMG T,WIDTH(I)
	TRO FITFUL
	CAMG T,SPACEW
	JRST FITOK
	SETOM ROTIT
	MOVE T,MAXY
	SUB T,MINY
	IMUL T,STEPS(I)
	CAMG T,WIDTH(I)
	TRO FITFUL
	CAMG T,SPACEW
	JRST FITOKA
	TRNN FITFUL
	JRST NOFIT
	MOVE T,WIDTH(I)
	SUB T,SPACEW
	ADDM T,LASTW
	MOVE T,SPACEH
	ADDM T,LASTH
	SETZM SPACEH
	MOVE T,WIDTH(I)
	MOVEM T,SPACEW
	JRST FITAGN

NOFIT:	DETCHK T,FORME1
	OUTSTR[ASCIZ/SORRY, TOO BIG FOR PLOTTER!
/]
	JRST FORME1

FITOKA:	MOVN T,MAXY
	EXCH T,MINX
	EXCH T,MINY
	MOVN T,T
	EXCH T,MAXX
	MOVEM T,MAXY
FITOK:	MOVN TT,LASTW
	IDIV TT,STEPS(I)
	ADD TT,MAXX
	HRLZ TTT,TT
	MOVN T,LASTH
	SUBI T,EDGEB
	IDIV T,STEPS(I)
	ADD T,MINY
	HRR TTT,T
	MOVE 1,TTT
	JSA SP,SETXY
	CLOSE DATCHN,
	PUSHJ P,INTFIL
	JRST FORME1
	PUSHJ P,LABEL
	JRST IDDIS		;PROCESS ID
;NOW WE PROCESS THE FILE
NOPDIS:
INLOP:	PUSHJ P,GETFIL
	JRST PARK		;END, GO PARK PEN
	HRRZ T,TTT
	CAILE T,MAXCOD
	JRST FORMER
	JRST @CODTAB(T)

MMDIS:	MOVEI T,MMNUM		;IGNORE MAX MINS NOW
MMDIS1:	PUSHJ P,GETFIL
	JRST FORMER
	SOJG T,MMDIS1
	JRST INLOP

DEFINE CODMAC $ (A,B)
<	JRST A$DIS
>

CODTAB:	CODES

IDDIS:	PUSHJ P,GETFIL
	JRST FORMER		;MUST HAVE ID
	JUMPE TTT,INLOP		;HOWEVER IT MAY BE NULL
	MOVE A,.JBREL
	HRLI A,(<POINT 7,0,34>)
	MOVE B,SAVFF
	ADD B,[<POINT 7,0,34>-1]
	SETZM CHRCNT
IDDIS1:	MOVE TT,TTT
IDDIS2:	SETZ T,
	LSHC T,7
	SKIPE TTT,T
	PUSHJ P,CHRPUT
	JUMPN TT,IDDIS2
	LDB TTT,DATHD+1
	TRNN TTT,376
	JRST IDDIS3
	PUSHJ P,GETFIL
	JRST FORMER
	JRST IDDIS1

IDDIS3:	SETZ TTT,
	PUSHJ P,CHRPUT
	DETCHK	TTT,IDDIS4
	OUTSTR @TXTPNT
	OUTSTR[ASCIZ/
/]
IDDIS4:	MOVNI TT,EDGEID		;WHERE TO PUT IT
	PUSHJ P,FINID
	JRST INLOP

VECDIS:	HLRZ C,TTT		;SAVE PEN COMMAND
	PUSHJ P,GETFIL
	JRST FORMER
	PUSHJ P,DIDLE
	JSA SP,PLOT
	JUMP A
	JUMP B
	JUMP C
	JRST INLOP

SYMDIS:	HLRZ C,TTT
	LDB D,[POINT 2,C,19]
	ANDI C,77777
	MOVE T,C
	IMULI T,CHRSTP
	IDIV T,STEPS(I)
	SKIPN C,T
	MOVEI C,1
	SKIPE ROTIT
	ADDI D,1	;ROTATE 90 DEGREES
	PUSHJ P,GETFIL
	JRST FORMER
	PUSHJ P,DIDLE
	HRRZ T,TXTPNT
DOTXT1:	PUSHJ P,GETFIL
	JRST FORMER
	CAMG T,.JBREL
	JRST DOTXT2
	MOVE TT,T
	CALLI TT,11
	JRST [	OUTSTR[ASCIZ/CAN'T EXPAND CORE!
/]
		CALLI 1,12
		JRST .-2]
DOTXT2:	MOVEM TTT,(T)
	TRNE TTT,376
	AOJA T,DOTXT1
	JSA SP,SYMBOL
	JUMP A
	JUMP B
	JUMP C
	JUMP D
TXTPNT:	JUMP 0		;FIXED UP TO TEXT BUFFER
	JRST INLOP

FORMER:	DETCHK T,PARK
	OUTSTR[ASCIZ/FORMAT ERROR, PLOT TERMINATED!
/]
PARK:	JSA SP,WHERE
	JUMP A
	JUMP B
	MOVNI C,3
	JSA SP,PLOT
	JUMP A
	JUMP B
	JUMP C
	CLOSE DATCHN,
	SUB B,MINY
	IMUL B,STEPS(I)
	ADDI B,EDGEB
	MOVNM B,LASTH
	SUB A,MINX
	IMUL A,STEPS(I)
	ADDI A,EDGEW
	MOVNM A,LASTW
	MOVE T,MINX
	SUB T,MAXX
	IMUL T,STEPS(I)
	SUBI T,EDGEW
	ADDM T,SPACEW
	MOVE T,MAXY
	SUB T,MINY
	IMUL T,STEPS(I)
	ADDI T,EDGET+EDGEB
	CAMLE T,SPACEH
	MOVEM T,SPACEH
	JRST CPOPJ1

FORMEE:	DETCHK T,FORME1
	OUTSTR[ASCIZ/FORMAT ERROR, PLOT NOT STARTED!
/]
FORME1:	CLOSE DATCHN,
	POPJ P,

GETFIL:	SOSG DATHD+2
	IN DATCHN,
	JRST GETOK
	DETCHK TTT,CPOPJ
	STATO DATCHN,1B22
	OUTSTR[ASCIZ/PLO FILE INPUT ERROR!
/]
	POPJ P,

GETOK:	ILDB TTT,DATHD+1
	JRST CPOPJ1

DIDLE:	HLRE A,TTT
	SCALE(A)
	HRRE TT,TTT
	SCALE(TT)
	MOVE B,TT
	SKIPN ROTIT
	POPJ P,
	MOVNS B,B
	EXCH A,B
	POPJ P,
;GENERATE A LABEL AT BOTTOM OF PLOT (TO START PEN)
LABEL:	MOVE A,.JBREL
	HRLI A,(<POINT 7,0,34>)		;POINTER TO LAST BYTE IN CORE
	MOVE B,SAVFF
	ADD B,[<POINT 7,0,34>-1]
	SETZM CHRCNT
	MOVE TT,[-1,,31]
	GETTAB TT,
	SETZ TT,
	PUSHJ P,SIXPUT			;USER NAME FIRST HALF
	MOVE TT,[-1,,32]
	GETTAB TT,
	SETZ TT,
	PUSHJ P,SIXPUT			;USER NAME SECOND HALF
	MOVEI TTT," "
	PUSHJ P,CHRPUT
	PUSHJ P,CHRPUT
	MOVE TT,(F)
	PUSHJ P,SIXPUT
	MOVEI TTT,"."
	PUSHJ P,CHRPUT
	HLLZ TT,1(F)
	PUSHJ P,SIXPUT
	MOVEI TTT,"["
	PUSHJ P,CHRPUT
	HLLZ TT,2(F)
	PUSHJ P,LSIXPUT
	MOVEI TTT,","
	PUSHJ P,CHRPUT
	HRLZ TT,2(F)
	PUSHJ P,LSIXPUT
	MOVEI TTT,"]"
	PUSHJ P,CHRPUT
	MOVEI TTT," "
	PUSHJ P,CHRPUT
	PUSHJ P,CHRPUT
	PUSHJ P,CHRPUT
	CALLI T,14
	IDIVI T,=31
	PUSH P,T
	MOVEI T,1(TT)
	IDIVI T,=10
	MOVEI TTT,60(T)
	PUSHJ P,CHRPUT
	MOVEI TTT,60(TT)
	PUSHJ P,CHRPUT
	MOVEI TTT,"-"
	PUSHJ P,CHRPUT
	POP P,T
	IDIVI T,=12
	ADD TT,[POINT 7,MONTAB]
MONLOP:	ILDB TTT,TT
	JUMPE TTT,MONDON
	PUSHJ P,CHRPUT
	JRST MONLOP

MONDON:	MOVEI TTT,"-"
	PUSHJ P,CHRPUT
	ADDI T,=64
	IDIVI T,=10
	MOVEI TTT,60(T)
	PUSHJ P,CHRPUT
	MOVEI TTT,60(TT)
	PUSHJ P,CHRPUT
	MOVEI TTT," "
	PUSHJ P,CHRPUT
	CALLI T,23
	IDIVI T,=1000*=60
	IDIVI T,=60
	PUSH P,TT
	IDIVI T,=10
	MOVEI TTT,60(T)
	PUSHJ P,CHRPUT
	MOVEI TTT,60(TT)
	PUSHJ P,CHRPUT
	MOVEI TTT,":"
	PUSHJ P,CHRPUT
	POP P,T
	IDIVI T,=10
	MOVEI TTT,60(T)
	PUSHJ P,CHRPUT
	MOVEI TTT,60(TT)
	PUSHJ P,CHRPUT
	SETZ TTT,
	PUSHJ P,CHRPUT
	MOVNI TT,EDGEB
FINID:	MOVEI D,=1200			;.12 INCHES WIDE TEXT
	IDIV D,STEPS(I)			;MAKE IT PLOTTER STEPS
	MOVE T,MAXX
	IDIV TT,STEPS(I)
	ADD TT,MINY
	MOVE TTT,D
	IMUL TTT,CHRCNT		;MOVE LEFT BY LENGTH OF STRING
	SUB T,TTT
	IDIVI D,CWIDTH			;NOW GET CHARACTER SIZE FROM WIDTH IN STEPS
	LSH D,3				;THIS IS FORMAT FOR SYMBOL
	JSA 16,SYMBOL
	JUMP T
	JUMP TT
	JUMP D
	JUMP [0]
	JUMP @TXTPNT
	POPJ P,

LSIXPUT:HLRZ T,TT
OCTPUT:	IDIVI T,10
	HRLM TT,(P)
	SKIPE T
	PUSHJ P,OCTPUT
	HLRZ TTT,(P)
	ADDI TTT,60
CHRPUT:	CAME B,A		;END OF CORE?
	JRST CHRPT1
CHRPT0:	MOVE A,.JBREL
	ADDI A,1
	CALLI A,11
	JRST [	DETCHK A,[MOVE A,.JBREL
			HRLI A,(<POINT 7,0,34>)
			POPJ P,]
		OUTSTR[ASCIZ/CANt GET CORE FOR LABEL STRING!
/]
		CALLI 1,12
		JRST CHRPT0]
	MOVE A,.JBREL
	HRLI A,(<POINT 7,0,34>)
	JRST CHRPUT

CHRPT1:	IDPB TTT,B
	AOS CHRCNT
	POPJ P,

SIXPT1:	SETZ T,
	LSHC T,6
	MOVEI TTT,40(T)
	PUSHJ P,CHRPUT
SIXPUT:	JUMPN TT,SIXPT1
	POPJ P,

MONTAB:	ASCII/JAN/
	ASCII/FEB/
	ASCII/MAR/
	ASCII/APR/
	ASCII/MAY/
	ASCII/JUN/
	ASCII/JUL/
	ASCII/AUG/
	ASCII/SEP/
	ASCII/OCT/
	ASCII/NOV/
	ASCII/DEC/

END STRT
    