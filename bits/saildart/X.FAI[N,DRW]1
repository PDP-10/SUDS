00100	COMMENT    VALID 00010 PAGES
00200	C REC  PAGE   DESCRIPTION
00300	C00001 00001
00400	C00002 00002	TITLE X
00500	C00003 00003	RPG MODE:
00600	C00009 00004	DOIT:	ANDCM C,BITTAB(D)
00700	C00010 00005		ADDI A,1
00800	C00011 00006	FRD:	MOVSI A,'PLX'
00900	C00012 00007	GETNAM:	MOVEI A,
01000	C00013 00008	XINI:	SKIPE RPGMOD
01100	C00017 00009	XGPOUT:	SKIPGE XGSFLG
01200	C00020 00010	FILNAM:	0
01300	C00021 ENDMK
01400	C;
     	00100	TITLE X
00200	
00300	XALL
00400	
00500	DEFINE SETSW $ (NAME,DEFVAL)
00600	<	IFNDEF NAME$SW,<NAME$SW__IFIDN <DEFVAL> <> <0;> DEFVAL
00700	>
00800		NAME$SW__NAME$SW
00900	>
01000	
01100	DEFINE ONOFSW $ (NAME,DEFVAL)
01200	<	SETSW(NAME,DEFVAL)
01300		IFN NAME$SW,<NAME$SW__-1>	;MAKE IT NICE FOR  AND 
01400	>
01500	DEFINE DEFSW $ (NAME)
01600	<	DEFINE NAME,<IFN NAME$SW>
01700		DEFINE NO$NAME,<IFE NAME$SW>
01800	>
01900	DEFINE MAKESW(NAME,VAL)
02000	<	ONOFSW(NAME,VAL)
02100		DEFSW(NAME)
02200	>
02300	
02400	MAKESW(STAN)
02500	MAKESW(DEC)
02600	MAKESW(CMU)
02700	MAKESW(ITS)
02800	
02900	DEFINE STANFO,<STAN>		;LONG FORM FOR HYSTERICAL RAISINS
03000	
03100	DEFINE CHECK $ (SITE,VAR) <IFDEF VAR,<SITE$SW__-1;>>
03200	IFE STANSW!DECSW!CMUSW!ITSSW,<
03300	;IF NO SITE SET MANUALLY ABOVE, WE MUST DECIDE FOR OURSELVES WHERE WE ARE
03400	CHECK(ITS,.IOT) CHECK(CMU,CMUDEC) CHECK(STAN,SPWBUT) DECSW__-1
03500	>
03600	
03700	NOCMU,<	NOLIT >
03800	
03900	MAKESW(FOONL,-1)
     	00100	A_1
00200	B_2
00300	C_3
00400	D_4
00500	E_5
00600	L_6
00700	U_7
00800	PEN_10
00900	X_11
01000	Y_12
01100	XD_13
01200	T_15
01300	TT_16
01400	P_17
01500	
01600	LPDL__69
01700	
01800	DSK__1
01900	XGP__2
02000	
02100	NOCMU,<
02200		LMAR__=0
02300		RMAR__=1699
02400		WIDTH__RMAR-LMAR+1
02500		LBUFL__<WIDTH+43>/44
02600		LSTBIT__1<LBUFL*44-WIDTH>
02700		BPI__=200
02800		LPI__=200
02900		EXTRA__2			;2 EXTRA WORDS AT END OF BIT IMAGE
03000	>;NOCMU
03100	CMU,<
03200		LMAR__0
03300		RMAR__=1555
03400		WIDTH__RMAR-LMAR+1
03500		SLOP__=40			;A LITTLE EXTRA IN CASE WIDTH TOO SMALL
03600		BYTES__<WIDTH+SLOP+7>/8+2	;NUMBER OF BYTES PER SCAN LINE (EXTRA 2 FOR ENTERING IMAGE MODE)
03700		LBUFL__<BYTES+3>/4
03800		BPI__WIDTH*2/=17		;BITS PER INCH ACROSS WIDTH OF PAPER
03900		LPI__=186			;SCAN LINES PER INCH
04000		EXTRA__4			;4 EXTRA WORDS AT END OF BIT IMAGE
04100	>;CMU
04200	OVERLAP__BPI/4			;OVERLAP 1/4 INCH
04300	BOTTOM__BPI/4			;SHIFT BOTTOM UP 1/4 INCH
04400	
04500	FOONL,<DOFF__2*BPI			;NUMBER OF STEPS TO WHERE P STARTS>
04600	NOFOONL,<DOFF__-(LMAR+RMAR+1)/2>
04700	
04800	NBUFS__4
04900	
05000	EXTERN JOBREL,JOBFF,JOBCOR
     	00100	NOCMU,<
00200		MAILBF:	BLOCK 40
00300	
00400		LINE:	0
00500		PNTR:	0
00600	>;NOCMU
00700	
00800	CMU,<
00900	MAXCOR:	777777	;Maximum CORE the user will let us use
00950	CORSTP__=20	;Amount of core (in K) we go down by if need too much
01000	>;CMU
     	00100	;RPG MODE:
00200	;REGISTER	CONTENTS
00300	;	0	FILENAME
00400	;	1	FILEXT
00500	;	2	FILPPN,,SPOOL FLAG
00600	;	3	MAX X,,MIN X	IN PLOTTER STEPS ALONG PAPER
00700	;	4	MAX Y,,MIN Y	IN PLOTTER STEPS ACROSS PAPER
00800	;	5	GETLIN DONE FROM PLOT PROG
00900	
01000	X.STRT:
01100	CMU,<	INTERNAL X.STRT>
01200		JRST NORPG	;NORMAL STARTUP
01300		SETOM RPGMOD
01400		MOVEM 0,FILNAM
01500		MOVEM 0,XGSNAM
01600		HLLZM 1,FILEXT
01700		HRLZM 1,XGSFLG#
01800		MOVEM 2,FILPPN
01900		MOVEM 2,XGSPPN
02000		MOVEM 3,RPGX#
02100		MOVEM 4,RPGY#
02200	NOCMU,<	MOVEM 5,LINE>
02300		OUTSTR[ASCIZ/WELCOME TO X!
02400	/]
02500	NOCMU,<	MOVE 1,['[PLX] ']
02600		MOVE P,[-LPDL,,PDL-1]
02700		PUSHJ P,DETCHK		;CHANGE OUR NAME IF DETACHED
02800		SETNAM 1,
02900	>;NOCMU
03000		JRST MERGE
03100	NORPG:	SETZM RPGMOD#
03200		SETZM XGSFLG
03300	NOCMU,<	SETOM LINE
03400		GETLIN LINE		;FOR ERROR PRINTOUT
03500	>;NOCMU
03600		MOVE P,[-LPDL,,PDL-1]
03700	CMU,<	PUSHJ P,.+2
03800		CALLI 12
03900		CALLI
04000	>;CMU
04100	MERGE:
04105	NOCMU,<	CALLI >
04110	CMU,<	HRRZ T,JOBCOR		;Did user specify core to use?
04120		HRRZ TT,JOBFF
04140		CAILE T,4000(TT)	;With at least 2k free?
04150		MOVEM T,MAXCOR		;Yes, limit ourselves
04160	>;CMU
04300	CMU,<	SKIPL XGSFLG
04400		SKIPA 1,[XWD 'IMG',0]
04500	>;CMU
04600		MOVSI 1,'XG0'
04700		MOVEM 1,XGSEXT
04800	NOCMU,<	HRRZS LINE >		;CLEAR LINE BITS
04900		SKIPE RPGMOD
05000		JRST YCHECK		;ALREADY HAVE FILENAME
05100	FILIN:	OUTSTR [ASCIZ /FILE?/]
05200		PUSHJ P,FRD
05300	YCHECK:	SKIPE RPGMOD
05400		JRST [	HRRE A,RPGY		;GET SMALL Y PASSED TO US
05450			HLRE T,RPGY		;GET HEIGHT OF DRAWING
05475			SUB T,A
05493			SUBI T,WIDTH		;DO WE NEED SPLICING?
05505			CAILE T,0
05518			MOVNI T,BOTTOM*2 	;YES USE A FIXED MARGIN
05593			ASH T,-1		;CENTER IT
05693			ADD A,T
05696			JRST YDEF ]
05700	YAGAIN:
05800	FOONL,<OUTSTR [ASCIZ/ORIGIN Y OFFSET (INCHES) FROM BOTTOM (DEFAULT IS -2.0)?/]>
05900	NOFOONL,<OUTSTR [ASCIZ/ORIGIN Y OFFSET (INCHES) FROM BOTTOM (DEFAULT IS CENTER OF PAGE (4.0))?/]>
06000		PUSHJ P,RNUM
06100		JRST [	MOVE A,[DOFF-BOTTOM]
06200			JRST YDEF]
06300		CAIN C,"+"
06400		JUMPE A,[PUSHJ P,RNUM
06500			JFCL
06600			IMUL A,[-WIDTH+OVERLAP]
06700			ADD A,[DOFF-BOTTOM]
06800			JRST YDEFP]
06900		IMULI A,BPI
07000		CAIN C,"."		;DECIMAL POINT?
07100		JRST [	INCHWL C
07200			CAIN C,15
07300			INCHWL C
07400			CAIL C,"0"
07500			CAILE C,"9"
07600			JRST .+1	;(REMEMBER .+1 IS OUTSIDE THE LITERAL)
07700			SUBI C,60
07800			IMULI C,BPI
07900			IDIVI C,=10	;CLOBBERS D, BUT WHO CARES!!!
08000			SKIPGE A
08100			MOVNI C,(C)
08200			ADD A,C
08300			PUSH P,A
08400			PUSHJ P,RNUM	;JUST GOBBLE THE REST
08500			JFCL
08600			POP P,A
08700			JRST .+1]
08800		MOVN A,A
08900	YDEFP:	CAIE C,12
09000		JRST [	CLRBFI
09100			JRST YAGAIN]
09200	YDEF:
09300	CMU,<	SKIPGE XGSFLG
09400		JRST YDEF2
09500		INIT XGP,14
09600		SIXBIT/DSK/
09700		XWD XGPBUF,0
09800		HALT .
09900		ENTER XGP,XGSNAM
10000		HALT .
10100		OUTBUF XGP,NBUFS
10200		OUT XGP,	;AND INITIALIZE THE FIRST BUFFER
10300		MOVSI T,1		;ASSUME LOTS OF CORE AT FIRST
10400		MOVEM T,MAXLIN#
10500	>;CMU
10600		MOVE T,JOBFF
10700		MOVEM T,SAVEFF#
10800	YDEF2:	MOVNM A,INIX#
10900		PUSHJ P,GETFIL
11000		JRST FILIN
11100	ASKLEN:	PUSHJ P,XINI
11200		JRST CORLUZ
11300		JRST DOPLOT
     	00100	GETFIL:	MOVE A,SAVEFF
00200		MOVEM A,JOBFF
00300		MOVE A,[FILNAM,,LKENT]
00400		BLT A,LKENT+3
00500		OPEN DSK,[14'DSK   'IBUF]
00600		HALT .
00700		INBUF DSK,NBUFS
00800		LOOKUP DSK,LKENT
00900		JRST FNF
01000		JRST POPJ1
01100	FNF:
01200	NOCMU,<	PUSHJ P,DETCHK
01300		PUSHJ P,XERR
01400	>;NOCMU
01500		PUSHJ P,ERRPNT
01600		ASCIZ /LOOKUP FAILED.
01700	/
01800	NOCMU,<	SKIPGE DET
01900		CALLI 12
02000	>;NOCMU
02100		SETZM RPGMOD
02200		POPJ P,
     	00100	CORLUZ:
00200	CMU,<	SKIPGE XGSFLG
00300		JRST CORLZ3
00310		HRLM T,(P)		;SAVE T IN CASE WE REALLY LOSE
00400		SUBI T,CORSTP		;DON'T BE TOO PIGGY
00500		CAIL T,=128		;CMU BUG -- CAN'T RUN IN > 128 K
00600		MOVEI T,=128-1
00700		LSH T,12		;MAKE IT WORDS
00800		SUB T,JOBFF
00900		IDIVI T,LBUFL+1		;MAKE IT SCAN LINES
00910		JUMPLE T,CORLZ2
00957		SKIPG TT,LTODO		;COMPUTE NUMBER OF PASSES IT WILL TAKE
00958		JRST CORLZ2
00960		ADDI TT,-1(T)
00977		IDIVM TT,T
00987		MOVE TT,LTODO		;COMPUTE LINES PER PASS
00992		ADDI TT,-1(T)
00997		IDIVM TT,T
01000		MOVEM T,MAXLIN
01100		JUMPG T,ASKLEN		;AND RETURN TO TRY AGAIN
01200	CORLZ2:	HLRZ T,(P)
01300	CORLZ3:
01400	>;CMU
01500		ADDI U,1777
01600		LSH U,-12
01700		SUBM U,T
01800		PUSH P,T
01900		PUSH P,U
02000	NOCMU,<	PUSHJ P,DETCHK
02100		PUSHJ P,XERR
02200	>;NOCMU
02300		POP P,T
02400		PUSHJ P,DECOUT
02500		PUSHJ P,ERRPNT
02600		ASCIZ / K OF CORE NEEDED, SHORT BY /
02700		POP P,T
02800		PUSHJ P,DECOUT
02900		PUSHJ P,ERRPNT
03000		ASCIZ / K
03100	/
03200	NOCMU,<	SKIPGE DET
03300		CALLI 12
03400	>;NOCMU
03500		SETZM RPGMOD
03600		JRST ASKLEN
03700	
03800	DECOUT:	IDIVI T,=10
03900		HRLM TT,(P)
04000		SKIPE T
04100		PUSHJ P,DECOUT
04200		HLRZ TT,(P)
04300		ADDI TT,60
04400		ROT TT,-7
04500		MOVEM TT,.+2
04600		PUSHJ P,ERRPNT
04700		0
04800		POPJ P,
     	00100	NOCMU,<
00200	LOSE:	PUSHJ P,DETCHK
00300		PUSHJ P,XERR
00400		PUSHJ P,ERRPNT
00500		ASCIZ /POINT OUT OF BOUNDS, /
00600		CAIGE Y,(L)
00700		JRST [	PUSHJ P,ERRPNT
00800			ASCIZ/-X/
00900			JRST LOSE1]
01000		PUSHJ P,ERRPNT
01100		ASCIZ/+X/
01200	LOSE1:	PUSHJ P,ERRPNT
01300		ASCIZ/, TRY AGAIN!
01400	/
01500		PUSHJ P,CORDWN
01600		SKIPGE DET
01700		CALLI 12
01800		SETZM RPGMOD
01900		JRST AGAIN
02000	>;NOCMU
     	00100	ERRPNT:	HRRZ TT,(P)
00200	NOCMU,<
00300		MOVEM TT,PNTR
00400		MOVEI TT,LINE
00500		TTYMES TT,
00600		JRST [	OUTSTR[ASCIZ/TTYMES FAILED	/]
00700			OUTSTR @PNTR
00800			OUTSTR[ASCIZ/
00900	/]
01000			JRST .+1]
01100	>;NOCMU
01200	CMU,<	OUTSTR (TT)>
01300		POP P,TT
01400		HRL TT,(TT)
01500		TLNE TT,376
01600		AOJA TT,.-2
01700		JRST 1(TT)
01800	
01900	NOCMU,<
02000	XERR:	PUSHJ P,ERRPNT
02100		ASCIZ/
02200	MESSAGE FROM X WORKING ON /
02300		MOVE TT,FILNAM
02400		PUSHJ P,SIXOUT
02500		PUSHJ P,ERRPNT
02600		ASCIZ/./
02700		HLLZ TT,FILEXT
02800		PUSHJ P,SIXOUT
02900		PUSHJ P,ERRPNT
03000		ASCIZ/[/
03100	NOCMU,<
03200		MOVE TT,FILPPN
03300		PUSHJ P,SIXOUT
03400	>;NOCMU
03500	CMU,<
03600		MOVE TT,[XWD FILPPN,PPNBUF]
03700		DECCMU TT,
03800		JRST [	MOVE TT,FILPPN
03900			PUSHJ P,SIXOUT
04000			JRST .+2]
04100		OUTSTR PPNBUF
04200	>;CMU
04300		PUSHJ P,ERRPNT
04400		ASCIZ/] : /
04500		POPJ P,
04600	>;NOCMU
04700	
04800	SIXOUT:	JUMPE TT,CPOPJ
04900		SETZ T,
05000		LSHC T,6
05100		ADDI T,40
05200		PUSH P,TT
05300		ROT T,-7
05400		MOVEM T,.+2
05500		PUSHJ P,ERRPNT
05600		0
05700		POP P,TT
05800		JRST SIXOUT
05900	
06000	NOCMU,<
06100	DETCHK:	SETOM DET#
06200		GETLIN DET
06300		HRRES DET
06400		SKIPL DET
06500		AOS (P)
06600		POPJ P,
06700	>;NOCMU
     	00100	NOCMU,<
00200	INOK:	MOVN E,IBUF+2
00300		MOVSI E,(E)
00400		HRR E,IBUF+1
00500	MAIN:	MOVE C,1(E)
00600		JFFO C,DOIT
00700		AOBJN E,MAIN
00800	DOPLOT:	IN DSK,
00900		JRST INOK
01000		STATO DSK,20000
01100		HALT .
01200		RELEAS DSK,
01300	IFN LSTBIT-1,<PUSHJ P,XFIX>
01400		JRST XGPOUT
01500	
01600	DOIT:	ANDCM C,BITTAB(D)
01700		XCT MOVI1(D)
01800		XCT MOVI2(D)
01900	DOI3:	XCT MOVI3(D)
02000	DOPEN:	TDNN C,MORMSK(D)	;DON'T MARK TILL BOTH HORIZ AND DIAG DONE!
02050		XCT PEN
02100		IORM B,@X
02200	DONXT:	JFFO C,DOIT
02300		AOBJN E,MAIN
02400		JRST DOPLOT
     	00100	MOVI1:	REPEAT 6,{
00200		HRLI PEN,(<CAIA>)
00300		HRLI PEN,(<TDNN C,(D)>)
00400		JUMPGE B,DOI3
00500		ROT B,-1
00600		SUBI Y,LBUFL+1
00700		ADDI Y,LBUFL+1
00800	
00900	MOVI2:	REPEAT 6,{
01000		JRST DONXT
01100		JRST DONXT
01200		XCT XMOVL(X)
01300		JUMPGE B,DOPEN
01400		CAIGE Y,(L)
01500		CAIL Y,-LBUFL-1(U)
01600	
01700	MOVI3:	REPEAT 6,{
01800		HALT .
01900		HALT .
02000		ROT B,1
02100		XCT XMOVR(X)
02200		JRST LOSE
02300		JRST LOSE
02400	
     	00100		ADDI A,1
00200	XMOVL:	HRLOI X,XD
00300		REPEAT LBUFL-1,<SUBI X,1>
00400		SOJL A,.+1
00500		MOVE X,[Y,,LBUFL-1]
00600		AOJA A,DOI3
00700	
00800		SOJL A,XONR
00900	XMOVR:	REPEAT LBUFL-1,<ADDI X,1>
01000		MOVE X,[XD,,LBUFL]
01100		ADDI A,1
01200	
01300	XONR:	MOVSI X,Y
01400		AOJA A,DOPEN
01500	>;NOCMU
     	00100	CMU,<
00200	DOPLOT:	SETZB E,C		;FORCE US TO GET A NEW BUFFER
00300		MOVSI T,1(L)		;CLEAR THE BUFFER
00400		HRRI T,2(L)
00500		SETZM 1(L)
00600		BLT T,(U)
00700		JRST UPNEXT		;AND START WITH THE PEN UP
00800	
00900	UPLOOP:	ANDCM C,BITTAB(D)
01000		XCT UPINS(D)
01100	UPNEXT:	JFFO C,UPLOOP
01200		JSP D,GETNXT
01300	
01400	DNLOOP:	ANDCM C,BITTAB(D)
01500		XCT DNINS(D)
01600		TDNN B,[37]
01700		JRST MARKIT
01800	FIXIT:	ROT B,-5
01900		HRREI T,(B)
02000		ADD X,T
02100		LSH B,5-=36
02200		CAML X,[Y,,0]
02300		CAMLE X,[Y,,LBUFL-1]
02400		JRST OFNEXT
02500	MARKIT: CAIL Y,2(L)
02600		CAILE Y,2-<LBUFL+1>-EXTRA(U)
02700		JRST DNNEXT
02800		MOVE T,XGPBIT(B)
02806		TDNN C,MORMSK(D)	;DON'T MARK TILL BOTH HORIZ AND DIAG DONE!
02900		IORM T,@X
03000	DNNEXT:	JFFO C,DNLOOP
03100		JSP D,GETNXT
03200	
03300	OFLOOP:	ANDCM C,BITTAB(D)
03400		XCT OFINS(D)
03500		TDNE B,[37]
03600		JRST FIXIT
03700	OFNEXT:	JFFO C,OFLOOP
03800		JSP D,GETNXT
     	00100	;NOTE: GETNXT RETURNS TO THE CALLING LOCATION MINUS 1 !!!!!
00200	
00300	GETNXT: MOVE C,2(E)		;GET A WORD
00400		AOBJN E,-2(D)		;AND IF IT'S LEGAL, USE IT
00500		IN DSK,			;ELSE READ SOME MORE
00600		JRST INOK
00700		STATO DSK,20000		;WHOOPS, THIS BETTER BE AN EOF
00800		HALT .			;NO? VERRRRRRY INTERESTING
00900		RELEAS DSK,		;YES -- WE ARE FINISHED WITH THE INPUT
01000		JRST XGPOUT		;SO GO OUTPUT IT
01100	
01200	INOK:	MOVN E,IBUF+2		;GET -WORDCOUNT
01300		HRLZI E,(E)		;PUT IT IN THE LEFT HALF
01400		HRR E,IBUF+1		;GET THE DATA POINTER
01500		MOVE C,1(E)		;GET THE FIRST DATA WORD
01600		JRST -2(D)		;AND GO USE IT
     	00100	UPINS:
00200	REPEAT 6,<
00300		JRST UPNEXT		;PEN UP
00400		JRST FIXIT		;PEN DOWN
00500		SUBI B,1		;MOVE DOWN
00600		ADDI B,1		;MOVE UP
00700		SUBI Y,LBUFL+1		;MOVE LEFT
00800		ADDI Y,LBUFL+1		;MOVE RIGHT
00900	>
01000	
01100	DNINS:
01200	REPEAT 6,<
01300		JRST UPNEXT		;PEN UP
01400		JRST DNNEXT		;PEN DOWN
01500		SUBI B,1		;MOVE DOWN
01600		ADDI B,1		;MOVE UP
01700		SUBI Y,LBUFL+1		;MOVE LEFT
01800		ADDI Y,LBUFL+1		;MOVE RIGHT
01900	>
02000	
02100	OFINS:
02200	REPEAT 6,<
02300		JRST UPNEXT		;PEN UP
02400		JRST OFNEXT		;PEN DOWN
02500		SUBI B,1		;MOVE DOWN
02600		ADDI B,1		;MOVE UP
02700		SUBI Y,LBUFL+1		;MOVE LEFT
02800		ADDI Y,LBUFL+1		;MOVE RIGHT
02900	>
03000	
03100	XGPBIT:
03200	FOR BYTE_0,3,1 <		;DO EACH BYTE LEFT - RIGHT
03300	FOR BIT_7,0,-1 <		;DO EACH BIT RIGHT - LEFT (FUNNY PDP-11!)
03400		1<=35-<BYTE*10+BIT>>
03500	>>
03600	
03700	>;CMU
     	09100	MORMSK:
09200	FOR I_=30,0,-6
09300	<	0
09400		0
09500		7I
09600		3I
09700		1I
09800		0
09900	>
     	00100	FRD:	MOVSI A,'PLX'
00200		MOVEM A,FILEXT
00300		PUSHJ P,GETNAM
00400		JUMPE A,XGSNAM
00500		MOVEM A,FILNAM
00600		MOVEM A,XGSNAM
00700	NONAM:	CAIE C,"."
00800		JRST NOEXT
00900		PUSHJ P,GETNAM
01000		MOVEM A,FILEXT
01100	NOEXT:	SETZM FILPPN
01200		CAIE C,"["
01300		JRST FRDX
01400	NOCMU,<	PUSHJ P,GETP
01500		HRLZM A,FILPPN
01600		PUSHJ P,GETP
01700		HRRM A,FILPPN
01800	>;NOCMU
01900	CMU,<	SETZM PPNBUF
02000		SETZM PPNBUF+1
02100		SETZM PPNBUF+2
02200		MOVEI A,=13	;AT MOST 13 CHARACTERS
02300		MOVE B,[POINT 7,PPNBUF]
02400	PPNL:	PUSHJ P,RCH
02500		JFCL
02600		CAIL C,"A"
02700		CAILE C,"Z"
02800		CAIN C,","
02900		JRST PPNCOK
03000		CAIL C,"0"
03100		CAILE C,"9"
03200		JRST GOTPPN
03300	PPNCOK:	IDPB C,B
03400		SOJG A,PPNL
03500	GOTPPN:	MOVE B,[XWD FILPPN,PPNBUF]
03600		CMUDEC B,
03700		SETOM FILPPN		;PASS ERRORS ON TO LOOKUP!!!
03800	>;CMU
03900	FRDX:	INCHRW C
04000		CAIE C,12
04100		JRST FRDX
04200		POPJ P,
04300	
04400	RNUM:	INCHWL C
04500		CAIN C,15
04600		JRST RNUM
04700		CAIN C,12
04800		POPJ P,
04900		AOS (P)
05000		MOVEI A,
05100		CAIN C,"-"
05200		JRST [	PUSHJ P,RNUML
05300			MOVN A,A
05400			POPJ P,]
05500		CAIA
05600	RNUML:	INCHWL C
05700		CAIL C,"0"
05800		CAILE C,"9"
05900		JRST RNUMX
06000		IMULI A,12
06100		ADDI A,-"0"(C)
06200		JRST RNUML
06300	
06400	RNUMX:	CAIN C,15
06500		INCHRW C
06600		POPJ P,
     	00100	GETNAM:	MOVEI A,
00200		MOVE B,[440600,,A]
00300	GETNML:	PUSHJ P,RCH
00400		POPJ P,
00500		SUBI C,40
00600		TLNE B,770000
00700		IDPB C,B
00800		JRST GETNML
00900	
01000	GETP:	MOVEI A,
01100	GETPL:	PUSHJ P,RCH
01200		POPJ P,
01300		TRNE A,770000
01400		JRST GETPL
01500		LSH A,6
01600		ADDI A,-40(C)
01700		JRST GETPL
01800	
01900	RCH:	INCHWL C
02000		CAIN C,42
02100		JRST RCHQ
02200		CAIE C,11
02300		CAIN C," "
02400		JRST RCH
02500		CAIE C,"."
02600		CAIN C,","
02700		POPJ P,
02800		CAIE C,"["
02900		CAIN C,"]"
03000		POPJ P,
03100	RCHQR:	CAIGE C,40
03200		POPJ P,
03300		CAIL C,"a"
03400		CAILE C,"z"
03500		CAIA
03600		SUBI C,40
03700		JRST POPJ1
03800	
03900	RCHQ:	INCHWL C
04000		JRST RCHQR
     	00100	XINI:
00200		SKIPE RPGMOD
00300		JRST [	HLRE A,RPGX	;GET MAX X
00400			HRRE B,RPGX	;AND MIN X
00500			SUB A,B		;FIND DIF
00575			MOVEI T,=11*LPI	;see if it's almost 11"
00587			SUB T,A
00687			CAIL T,0	;if it is longer than 11"
00693			CAILE T,<=11-=10>*LPI	;or less than 10"
00696			MOVEI T,LPI/2	;then use 1/4" margins
00698			ADD A,T		;ADD BOTH MARGINS INTO SIZE
00699			ASH T,-1
00700			SUB B,T		;INCORPORATE 1 MARGIN INTO MIN X
00800			IMUL B,[-LBUFL-1]	;MAKE IT WORDS IN MEMORY
00900			MOVEM B,IYPOS	;INITIAL Y POS
01000			JRST XDEF]
01100	XINI1:	OUTSTR [ASCIZ /TOTAL LENGTH IN INCHES (X DIMENSION, DEFAULT = 11)?/]
01200		PUSHJ P,RNUM
01300		MOVEI A,=11		;ASSUME 11 INCHES
01400		JUMPLE A,[XINLER:CLRBFI
01500			JRST XINI1]
01600		CAIE C,12
01700		JRST XINLER
01800		IMULI A,LPI
01900		PUSH P,A		;SAVE THIS
02000	YINI1:	OUTSTR [ASCIZ \ORIGIN X OFFSET FROM LEFT END(DEFAULT IS 1/2 LENGTH)?\]
02100		PUSHJ P,RNUM
02200		JRST [	MOVE A,(P)
02300			ASH A,-1
02400			JRST IYDEF]
02500		CAIE C,12
02600		JRST [	CLRBFI
02700			JRST YINI1]
02800		IMULI A,LPI
02900	IYDEF:	IMULI A,LBUFL+1
03000		MOVEM A,IYPOS#
03100		POP P,A
03200	XDEF:
03300	CMU,<
03400		MOVEM A,LTODO#	;SAVE TOTAL NUMBER OF LINES
03500		SKIPL XGSFLG	;ARE WE PACKING?
03600		CAMG A,MAXLIN	;YES, IS IT TOO LONG?
03700		CAIA		;NO
03800		MOVE A,MAXLIN	;YES, DO ONLY THE FIRST PART
03900	>;CMU
04000		MOVEM A,LINCNT#
04100		IMULI A,LBUFL+1
04200		HRRZ L,JOBFF
04300		SUBI L,1
04400		MOVEM L,XGPPTR
04500		MOVNI T,EXTRA(A)
04600		HRLM T,XGPPTR
04700		SUBI T,(L)
04800		MOVNS U,T		;U := T := -T
04850	CMU,<	CAMLE T,MAXCOR		;DON'T USE MORE CORE THAN USER WANTS
04875		JRST [	MOVE T,MAXCOR
04887			ADDI T,CORSTP*2000+1
04893			ASH T,-=10
04896			POPJ P,]
04898	>;CMU
04900		CORE T,
05000		POPJ P,
05100	NOCMU,<	MOVSI T,1(L)
05200		HRRI T,2(L)
05300		SETZM 1(L)
05400		MOVE U,JOBREL
05500		BLT T,(U)
05600	>;NOCMU
     	00100		MOVE Y,IYPOS
00200		ADDI Y,2(L)
00300	NOCMU,<
00400		MOVE PEN,[CAIA BYTTAB]
00500		MOVEI XD,DBUF+1
00600		SKIPL A,INIX		;WHERE DO WE START
00700		JRST MAYBON
00800		SUBI A,43
00900		IDIV A,[-44]
01000		HRLOI X,XD
01100		SOJA A,SETB
01200	
01300	MAYBON:	ADDI A,43
01400		IDIVI A,44
01500		CAILE A,LBUFL
01600		JRST OFFRT
01700		MOVE X,A
01800		SETZ A,
01900		HRLI X,Y
02000		JRST SETB
02100	
02200	OFFRT:	MOVE X,[XD,,LBUFL]
02300		SUBI A,LBUFL
02400	SETB:	MOVE B,INIX
02500		IDIVI B,44
02600		MOVSI B,400000
02700		MOVN C,C
02800		ROT B,(C)
02900	>;NOCMU
03000	CMU,<
03100		MOVE B,INIX
03200		ADDI B,20		;ALLOW FOR THE 2 LEADING CONTROL BYTES
03300		ROT B,-5
03400		HRREI X,(B)
03500		ADD X,[(Y)]
03600		LSH B,5-=36
03700		MOVEM B,SAVEB#
03800		MOVEM X,SAVEX#
03900		MOVEM Y,SAVEY#
04000	>;CMU
04100	POPJ1:	AOS (P)
04200	CPOPJ:	POPJ P,
     	00100	XGPOUT:
00200		MOVE A,LINCNT
00300	CMU,<	SKIPL XGSFLG
00400		JRST PAKXGP
00500	>;CMU
00600	NOCMU,<
00700		SUBI A,1
00800		MOVE TT,[BYTE (12)4001,LMAR,LBUFL]
00900		MOVEM TT,1(L)		;FIRST ONE HAS MARK AND CUT WITH IT
01000		TLZ TT,400000		;DELETE MARK AND CUT
01100		MOVEI T,1+LBUFL+1(L)
01200	>;NOCMU
01300	CMU,<
01400		MOVEI TT,BYTES
01500		MOVEI B,2		;COMMAND TO PUT XGP IN IMAGE MODE
01600		MOVEI T,1(L)
01700	>;CMU
01800	XINL:	MOVEM TT,(T)
01900	CMU,<	DPB B,[POINT 16,1(T),15]>	;FIRST 2 BYTES OF EACH LINE ARE "ENTER IMAGE MODE"
02000		ADDI T,LBUFL+1
02100		SOJG A,XINL
02200	NOCMU,<
02300		MOVSI TT,400100
02400		MOVEM TT,(T)
02500		SKIPL XGSFLG
02600		JRST [	OPEN XGP,[1017'XGP   '0]
02700			JRST NOXGP
02800			OUTSTR[ASCIZ/CRANKING XGP
02900	/]
03000			LOCK
03100			JRST OUTIT]
03200	>;NOCMU
03300	CMU,<
03400		SETZM 0(T)
03500		MOVSI TT,(<BYTE (8)1>)
03600		MOVEM TT,1(T)
03700		SETZM 2(T)
03800	>;CMU
03900		OPEN XGP,[16'DSK   '0]
04000		JRST DSKERR
04100		HLLZS XGSEXT
04200		SETZM XGSEXT+1
04300		MOVE A,XGSPPN
04400		ENTER XGP,XGSNAM
04500		JRST DSKERR
04600		MOVEM A,XGSPPN
04700	OUTIT:	OUT XGP,XGPPTR
04800		JRST OUTOK
04900	DSKERR:
05000	NOCMU,<	PUSHJ P,DETCHK
05100		PUSHJ P,XERR
05200	>;NOCMU
05300		PUSHJ P,ERRPNT
05400		ASCIZ /XGP OUTPUT ERROR.
05500	/
05600	OUTOK:
05700	NOCMU,<	SKIPL XGSFLG
05800		UNLOCK
05900	>;NOCMU
06000		RELEAS XGP,
06100	OUTOK2:	SKIPN RPGMOD
06200		JRST XMORE
06300		MOVSI A,1
06400		ADDM A,XGSEXT		;SETUP FOR NEXT PART OF XG.. FILE
06500		MOVN A,INIX
06600		ADDI A,WIDTH-OVERLAP	;MAKE SURE WE CAN TAPE IT
06700		HLRE B,RPGY		;GET MAX Y
06800		SUBI B,OVERLAP		;ACCOUNT FOR OVERLAP IN A
06900		CAMGE A,B		;HIGH ENOUGH YET?
07000		JRST [	OUTSTR[ASCIZ/GOING BACK FOR ANOTHER PASS
07100	/]
07200			JRST YDEF2]		;NO, MAKE ANOTHER PASS
07300	XMORE:
07400	CMU,<	SKIPL XGSFLG
07500		JRST [	MOVEI T,0
07600			PUSHJ P,PUTXGP	;WRITE THE EOF MARK
07700			PUSHJ P,PUTXGP
07800			RELEAS XGP,
07900			JRST .+1 ]
08000	>;CMU
08100		PUSHJ P,CORDWN			;REALLY DONE, CORE DOWN
08200	NOCMU,<	PUSHJ P,DETCHK >		;IF DETACHED AT STANFORD
08300	CMU,<	SKIPE RPGMOD >			;OR IF IN RPG MODE AT CMU
08400		JRST DODEL			;DELETE AUTOMATICALLY
08500		OUTSTR[ASCIZ/DELETE PLX FILE?/]
08600		INCHRW C
08700		CAIN C,15
08800		INCHRW C
08900		CAIE C,12
09000		OUTSTR[ASCIZ/
09100	/]
09200		CAIE C,"Y"
09300		CAIN C,"y"
09400		CAIA
09500		JRST NODEL
09600	DODEL:	MOVE A,[FILNAM,,LKENT]
09700		BLT A,LKENT+3
09800		INIT DSK,17
09900		'DSK   '
10000		0
10100		JRST [
10200	NOCMU,<
10300			SKIPGE DET
10400			PUSHJ P,XERR
10500	>;NOCMU
10600			PUSHJ P,ERRPNT
10700			ASCIZ/COULDN'T GET DISK FOR DELETE!
10800	/
10900			JRST NODEL]
11000		LOOKUP DSK,LKENT
11100		JRST [
11200	NOCMU,<		SKIPGE DET
11300			PUSHJ P,XERR
11400	>;NOCMU
11500			PUSHJ P,ERRPNT
11600			ASCIZ/LOOKUP FOR DELETE FAILED!
11700	/
11800			JRST NODEL]
11900		MOVE A,FILPPN
12000		MOVEM A,LKENT+3
12100		SETZM LKENT
12200		RENAME DSK,LKENT
12300		CAIA
12400		JRST NODEL
12500	NOCMU,<	SKIPGE DET
12600		PUSHJ P,XERR
12700	>;NOCMU
12800		PUSHJ P,ERRPNT
12900		ASCIZ/RENAME FOR DELETE FAILED!
13000	/
13100	NODEL:	RELEASE DSK,
13200	NOCMU,<	SKIPGE DET
13300		PUSHJ P,XERR
13400	>;NOCMU
13500		PUSHJ P,ERRPNT
13600		ASCIZ/
13700	XGP OUTPUT FINISHED
13800	/
13900	CMU,<	POPJ P, >
14000	NOCMU,<	CALLI 12		;LEAVE
14100	
14200	NOXGP:	PUSHJ P,DETCHK
14300		PUSHJ P,XERR
14400		PUSHJ P,ERRPNT
14500		ASCIZ /XGP NOT AVAILABLE (I THOUGHT I WAS WAITING FOR IT)!
14600	/
14700		POPJ P,
14800	>;NOCMU
14900	
15000	XGPPTR:	BLOCK 2
15100	
15200	NOCMU,<
15300	IFN LSTBIT-1,<
15400	XFIX:	MOVE A,[LSTBIT-1]
15500		MOVE C,LINCNT
15600		HRRZ D,XGPPTR
15700	XFIXL:	ANDCAM A,LBUFL-1+2(D)
15800		ADDI D,LBUFL+1
15900		SOJG C,XFIXL
16000		POPJ P,
16100	>;IFN LSTBIT-1
16200	>;NOCMU
16300	
16400	CORDWN:	MOVE T,JOBFF
16500		SUBI T,1
16600		CORE T,
16700		HALT .
16800		POPJ P,
     	00100	CMU,<
00200	PAKXGP:	MOVEI D,1(L)
00300	PAKL1:	ADD D,[XWD -LBUFL,1]
00400		MOVE E,[POINT 8,XGPVEC]
00500		SETZ PEN,
00600		IDPB PEN,E		;SWITCH TO VECTOR MODE
00700		IDPB PEN,E
00800		MOVE T,(D)
00900		MOVEI C,20
01000		SKIPA B,[XWD -20,20]
01100	CHGBW:	MOVSI B,-40
01200	CHBWL:	TDNN T,XGPBIT(B)
01300		AOBJN B,CHBWL		;LOOP TILL WE FIND A 1
01400		JUMPGE B,CHBWDN		;GET OUT OF HERE IF WE DID NOT FIND 1
01500		SUBI C,40
01600		ADDI C,(B)
01700		CAIL C,400		;IF WE HAVE MORE THAN 255 POINTS
01800		JRST [	MOVEI TT,377	;PUT OUT THE FIRST 255
01900			IDPB TT,E
02000			MOVEI TT,0	;AND 0 OF THE OTHER COLOR
02100			IDPB TT,E
02200			SUBI C,377
02300			JRST .-1	;SEE IF WE FIT YET
02400			]
02500		IDPB C,E		;SAVE THE COUNT
02600		HRREI TT,-XGPVND(E)	;MAKE SURE WE HAVE NOT GONE TOO FAR
02700		JUMPGE TT,NOPAK		;WOULD BE FASTER JUST TO USE THE IMAGE!!
02800		MOVEI C,40
02900		SUBI C,(B)
03000		SETCA PEN,
03100		SETCA T,
03200		AOBJN B,CHBWL		;AND CHECK THE NEXT BIT
03300	CHBWDN:	AOBJP D,PAKDN	;NO MORE BITS, CHECK THE NEXT WORD
03400	PAKL2:	ADDI C,40		;ASSUME THE 32 BITS ARE ALL TO BE SAME COLOR
03500		MOVE T,(D)		;GET THE BITS
03600		XOR T,PEN		;ADJUST FOR CURRENT COLOR
03700		TDNE T,[17]		;IS IT ALL THIS COLOR
03800		JRST CHGBW		;NO, GO CHANGE THE COLOR
03900		AOBJN D,PAKL2		;ELSE GET NEXT WORD
04000	
04100	PAKDN:	JUMPGE PEN,PKL1ND	;DON'T BOTHER PUTTING OUT EXTRA WHITE
04200		CAIL C,400
04300		JRST [	MOVEI TT,377	;PUT OUT THE FIRST 255
04400			IDPB TT,E
04500			MOVEI TT,0	;AND 0 OF THE OTHER COLOR
04600			IDPB TT,E
04700			SUBI C,377
04800			JRST .-1	;SEE IF WE FIT YET
04900			]
05000		IDPB C,E		;SAVE THE COUNT
05100	PKL1ND:	MOVEI T,0
05200		IDPB T,E		;GET OUT OF VECTOR MODE
05300		IDPB T,E
05400		IDPB T,E		;AND TERMINATE THE SCAN
05500		MOVEI T,1
05600		IDPB T,E
05700		MOVNI T,-XGPVEC+1(E)	;GET THE WORD COUNT
05800		HRLZ TT,T
05900		MOVN T,T		;MAKE IT POSITIVE
06000		ASH T,2			;MAKE IT A BYTE COUNT
06100	FOR I_7,=23,=8			;DROP ANY EXTRA BYTES
06200	<	CAML E,[POINT 0,0,I]
06300		SUBI T,1
06400	>
06500		CAIN T,6		;SPECIAL CASE NULL VECTORS
06600		JRST [	MOVEI T,0	;CONTROL WORD
06700			PUSHJ P,PUTXGP
06800			MOVSI T,(<BYTE (8)2,1>)	;SKIP ONE LINE
06900			PUSHJ P,PUTXGP
07000			JRST PAKNXT ]
07100		PUSHJ P,PUTXGP
07200		HRRI TT,XGPVEC
07300	PUTXL:	MOVE T,(TT)
07400		PUSHJ P,PUTXGP
07500		AOBJN TT,PUTXL
07600	PAKNXT:	SOJG A,PAKL1
07700		MOVN T,MAXLIN
07800		ADDB T,LTODO		;GET N LINES LEFT TO DO
07900		JUMPG T,[		;MORE TO DO?
08000			MOVN Y,MAXLIN	;YES, ADVANCE TO NEXT PART
08100			IMULI Y,LBUFL+1
08200			ADDB Y,SAVEY
08300			MOVE X,SAVEX	;RESTORE X,B
08400			MOVE B,SAVEB
08500			CAMGE T,MAXLIN	;LESS THAN MAXLIN LEFT?
08600			MOVEM T,LINCNT	;YES, REDUCE LINCNT
08700			PUSHJ P,GETFIL	;GET THE FILE AGAIN
08800			HALT .
08900			JRST DOPLOT ]	;AND GO DO MORE
09000		MOVEI T,0		;PUT OUT A PAPER CUT
09100		PUSHJ P,PUTXGP
09200		MOVSI T,(<BYTE (8)1>)
09300		PUSHJ P,PUTXGP
09400		JRST OUTOK2		;AND THAT'S THAT
     	00100	PUTXGP:	IDPB T,XGPBUF+1
00200		SOSG XGPBUF+2
00300		OUT XGP,
00400		POPJ P,
00500		HALT .
00600	
00700	NOPAK:	MOVEI T,BYTES
00800		PUSHJ P,PUTXGP
00900		HLRE TT,D
01000		MOVNI TT,LBUFL(TT)
01100		HRLI TT,-1(TT)
01200		ADD TT,D
01300		HRRZI D,LBUFL(TT)
01400		MOVEI T,2		;DON'T FORGET TO ENTER IMAGE MODE
01500		DPB T,[POINT 16,(TT),15]
01600		JRST PUTXL
01700	>;CMU
     	00100	FILNAM:	0
00200	FILEXT:	0
00300		0
00400	FILPPN:	0
00500	
00600	LKENT:	BLOCK 4
00700	
00800	XGSNAM:	0
00900	XGSEXT:	0
01000		0
01100	XGSPPN:	0
01200	CMU,<
01300	PPNBUF: BLOCK 3		;BUFFER FOR CONVERTING PPN'S
01400	XGPBUF:	BLOCK 3		;BUFFER HEADER FOR PACKED XGP OUTPUT
01500	XGPVEC:	BLOCK LBUFL	;FOR VECTORIZING (PACKING) THE IMAGE
01600	XGPVND:	BLOCK 20	;AND A FEW EXTRA WORDS FOR OVERFLOW
01700	>;CMU
01800	IBUF:	BLOCK 3
01900	
02000	BITTAB:	FOR I_43,0,-1{1I
02100	
02200	BYTTAB:	FOR I_36,0,-6{REPEAT 6,{77I
02300	
02400	NOCMU,<
02500	DBUF:	BLOCK LBUFL+2
02600	>;NOCMU
02700	
02800	PDL:	BLOCK LPDL
02900	
03000	END X.STRT
    